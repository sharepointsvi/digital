<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Engineer Visit Dashboard - Live SharePoint Excel
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet"/>
  <!-- Tabulator CSS & JS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet"/>
  <style>
   :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

		#sidebarMenu {
		  width: 220px;
		  transition: all 0.3s ease;
		}
		#sidebarMenu.collapsed {
		  width: 60px;
		}
		#sidebarMenu a.nav-link {
		  font-size: 0.9rem;
		  border-radius: 5px;
		  padding: 6px 10px;
		}
		#sidebarMenu a.nav-link:hover {
		  background-color: rgba(255,255,255,0.1);
		}
		.page-section {
		  transition: opacity 0.3s ease;
		}

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            height: 100%;
            border-top: 4px solid var(--secondary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-icon {
            font-size: 2.5rem;
            color: var(--secondary);
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
        }

        .table th {
            background-color: var(--light);
            font-weight: 600;
        }

        .badge-active {
            background-color: var(--success);
        }

        .badge-upcoming {
            background-color: #f39c12;
        }

        .badge-completed {
            background-color: #7f8c8d;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 28px;
        }
		


        .engineer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        #zoneStatusFilters {
            background: white;
            border-radius: 10px;
            padding: 12px 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            display: flex;
            gap: 1rem;
            align-items: center;
            font-weight: 600;
        }
        
        #zoneStatusFilters label {
            margin-bottom: 0;
            user-select: none;
        }
        
        #zoneStatusFilters select {
            min-width: 120px;
        }

        #visitDetailCard {
            display: none;
            position: fixed;
            top: 60px;
            right: 20px;
            width: 360px;
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1050;
        }
        
        #visitDetailCard h4 {
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        #visitDetailCard label {
            font-weight: 600;
            margin-top: 10px;
            display: block;
        }
        
        #visitDetailCard input,
        #visitDetailCard select,
        #visitDetailCard textarea {
            width: 100%;
            padding: 6px 8px;
            margin-top: 2px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        #visitDetailCard textarea {
            resize: vertical;
        }
        
        #visitDetailCard button {
            margin-top: 15px;
            width: 48%;
            font-weight: 600;
        }
        
        #visitDetailCard .btn-group {
            display: flex;
            justify-content: space-between;
        }

        /* Settings Panel Styles */
        #settingsPanel {
            display: none;
            position: fixed;
            top: 60px;
            right: 20px;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1060;
        }
        
        #settingsPanel h4 {
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
        }
        
        #settingsPanel label {
            font-weight: 600;
            margin-top: 10px;
            display: block;
            color: var(--dark);
        }
        
        #settingsPanel input,
        #settingsPanel select {
            width: 100%;
            padding: 8px 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        #settingsPanel .form-text {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
        }
        
        #settingsPanel .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            cursor: pointer;
        }
        
        .settings-btn:hover {
            background: var(--primary);
            transform: rotate(45deg);
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .stat-number {
                font-size: 2rem;
            }
            
            #visitDetailCard {
                width: 90vw;
                top: 70px;
                right: 5vw;
            }
            
            #settingsPanel {
                width: 90vw;
                top: 70px;
                right: 5vw;
            }
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1100;
        }
        
        /* Toast styles for Bootstrap 5 */
        .toast {
            width: 350px;
            max-width: 100%;
            font-size: 0.875rem;
            background-clip: padding-box;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
            opacity: 0;
            border-radius: 0.25rem;
            margin-bottom: 10px;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast-header {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            color: #6c757d;
            background-color: rgba(255, 255, 255, 0.85);
            background-clip: padding-box;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            border-top-left-radius: calc(0.25rem - 1px);
            border-top-right-radius: calc(0.25rem - 1px);
        }
        
        .toast-body {
            padding: 0.75rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Custom status colors */
        .bg-purple {
            background-color: #6f42c1 !important;
        }
        
        .bg-overdue {
            background-color: #dc3545 !important;
        }
        
        /* Highlight selected table row */
        .table-hover tr.selected {
            background-color: rgba(52, 152, 219, 0.2) !important;
        }
        
        /* Responsive table styling */
        .table-responsive {
            overflow-x: auto;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                width: 100%;
                margin-bottom: 15px;
                overflow-y: hidden;
                -ms-overflow-style: -ms-autohiding-scrollbar;
                border: 1px solid #ddd;
            }
        }
				/* Force Zone and Status filters to same height */
		.choices__inner, 
		#tableZoneFilter {
		  min-height: 2.4rem !important;
		  height: 2.4rem !important;
		  display: flex;
		  align-items: center;
		  padding: 0 0.5rem;
		}

		/* ===== Timeline Scroll CSS (added for horizontal scrolling) ===== */
		.timeline-scroll-wrapper {
		  overflow-x: auto;
		  overflow-y: hidden;
		  -webkit-overflow-scrolling: touch;
		  padding-bottom: 8px; /* space for scrollbar */
		}

		.timeline-canvas {
		  display: inline-block;
		  height: 250px;
		  max-height: 250px;
		}
		
		/* === Weekly Workload Calendar === */
		#workloadBoard table {
		  border-collapse: collapse;
		  table-layout: fixed;
		  min-width: 1200px;
		}
		#workloadBoard th, #workloadBoard td {
		  text-align: center;
		  font-size: 0.8rem;
		  border: 1px solid #eee;
		  height: 28px;
		  padding: 0;
		}
		.cell-active   { background-color: #4caf50; }  /* green */
		.cell-upcoming { background-color: #ffeb3b; }  /* yellow */
		.cell-complete { background-color: #9e9e9e; }  /* grey  */
		.cell-empty    { background-color: #ffffff; }  /* white */
		.sticky-left   { position: sticky; left: 0; z-index: 2; }
		.sticky-top    { position: sticky; top: 0; z-index: 3; }

/* === Modern Workload Calendar (Fixed & Visible) === */
#workloadBoardContainer {
  overflow-x: auto;
  overflow-y: auto;           /* ‚úÖ Allow vertical scrolling */
  white-space: nowrap;
  border-top: 1px solid #dee2e6;
  background: #fff;           /* ‚úÖ Ensure visible background */
  min-height: 500px;          /* ‚úÖ Give it space */
  padding: 10px;
}

/* Grid Layout */
.workload-grid {
  display: grid;
  grid-template-columns: 150px repeat(14, 60px);
  border-collapse: collapse;
  width: max-content;
  background-color: #fff;
}


/* Maintain sticky headers */
.workload-header,
.workload-row {
  display: contents;
}

/* Common cell look */
.workload-cell,
.workload-head {
  font-weight: 600;
  background: #f8f9fa;
  position: sticky;
  top: 0;
  z-index: 10; /* Keep above cells */
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Sticky top date header */
.workload-head {
  font-weight: 600;
  background: #f8f9fa;
  position: sticky;
  top: 0;
  z-index: 10; /* Keep above cells */
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Sticky left engineer column */
.workload-engineer {
  font-weight: 500;
  background: #f8f9fa;
  position: sticky;
  left: 0;
  z-index: 3;
  text-align: left;
  padding-left: 8px;
  border: 1px solid #e0e0e0;
}

/* Status coloring */
.cell-active   { background-color: #19875433; }  /* soft green */
.cell-upcoming { background-color: #ffc10733; }  /* soft yellow */
.cell-complete { background-color: #6c757d33; }  /* soft grey */
.cell-empty    { background-color: #ffffff; }     /* white */

/* Optional: Add hover clarity */
.workload-cell:hover {
  outline: 1px solid #0d6efd33;
  cursor: pointer;
}

.workload-grid > .workload-head:first-child {
  border-top: 2px solid #ddd;
}

/* === Workload Page Visibility Fix === */
#workloadPage,
#workloadPage .card.shadow-sm,
#workloadBoardContainer {
  display: block !important;
  flex: 1 1 auto !important;
  height: auto !important;
  min-height: 600px !important;
  overflow: visible !important;
  background: #fff !important;
  position: relative !important;
  z-index: 1 !important;
}

/* === Final Flex-Layout Fix for Workload Page === */

/* 1Ô∏è‚É£  the global dashboard layout */
#dashboardLayout {
  display: flex;
  flex-direction: row;
  align-items: stretch;
  width: 100%;
  height: 100vh;
}

/* 2Ô∏è‚É£  the right-hand main content column */
#mainContent {
  display: flex !important;
  flex-direction: column !important;
  flex: 1 1 auto !important;
  min-width: 0 !important;          /* allow shrinking next to sidebar */
  min-height: 100vh !important;
  overflow: auto !important;
  background: #fff;
}

/* 3Ô∏è‚É£  every ‚Äúpage‚Äù section inside mainContent */
.page-section {
  flex: 1 1 auto !important;
  display: block !important;
  width: 100% !important;
  min-height: 100% !important;
  height: auto !important;
  overflow: visible !important;
}

/* 4Ô∏è‚É£  the workload-specific containers */
#workloadPage,
#workloadBoardContainer,
#workloadPage .card.shadow-sm {
  flex: 1 1 auto !important;
  display: block !important;
  width: 100% !important;
  min-width: 100% !important;
  min-height: 700px !important;
  height: auto !important;
  overflow: auto !important;
  background: #fff;
  position: relative;
  z-index: 5;
}


		
		/* ===== End Timeline Scroll CSS ===== */
  </style>
  <style>
   /* ======= Enhanced Presence Button Style ======= */
.btn-presence {
  background: linear-gradient(135deg, #00b4d8, #0077b6);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.45rem 1rem;
  font-weight: 500;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  transition: all 0.25s ease-in-out;
}
.btn-presence i {
  font-size: 1rem;
}
.btn-presence:hover {
  background: linear-gradient(135deg, #0096c7, #005f73);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.25);
}
.btn-presence:active {
  transform: scale(0.97);
  box-shadow: 0 2px 4px rgba(0,0,0,0.25);
}
.btn-presence:focus {
  outline: none;
  box-shadow: 0 0 0 0.2rem rgba(0, 183, 255, 0.4);
}
  </style>
  <style>
   /* ======= Presence Card Styling ======= */
#presenceDetailCard {
  position: fixed;
  top: 80px;
  right: 40px;
  width: 400px;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  padding: 24px;
  z-index: 1060;
  display: none;
  transition: all 0.3s ease;
}

#presenceDetailCard.show {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

#presenceDetailCard h4 {
  margin-bottom: 1rem;
  font-weight: 600;
  color: #023047;
}

#presenceForm label {
  display: block;
  font-weight: 500;
  color: #333;
  margin-top: 0.5rem;
  margin-bottom: 0.25rem;
}

#presenceForm input,
#presenceForm select,
#presenceForm textarea {
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px 8px;
  font-size: 0.9rem;
  outline: none;
  transition: all 0.2s ease-in-out;
}

#presenceForm input:focus,
#presenceForm select:focus,
#presenceForm textarea:focus {
  border-color: #00b4d8;
  box-shadow: 0 0 0 2px rgba(0, 180, 216, 0.25);
}

#presenceForm textarea {
  resize: none;
}

#presenceForm .btn {
  flex: 1;
  font-weight: 500;
  transition: 0.2s;
}

#presenceForm .btn-primary {
  background-color: #0077b6;
  border: none;
}

#presenceForm .btn-primary:hover {
  background-color: #023e8a;
}

#presenceForm .btn-secondary {
  background-color: #adb5bd;
  border: none;
}

#presenceForm .btn-secondary:hover {
  background-color: #6c757d;
}

#presenceForm .btn-danger {
  background-color: #d62828;
  border: none;
}

#presenceForm .btn-danger:hover {
  background-color: #b91d1d;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

<style>
/* üßä FLAT, MODERN GLASS STYLE (no convex or inset shadow) */

.workload-cell {
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 4px;
backdrop-filter: none;
-webkit-backdrop-filter: none;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.workload-cell:hover {
  transform: scale(1.03);
  border-color: rgba(0, 0, 0, 0.1);
}

/* üåà PRESENCE COLORS (Sheet2) */
.presence-office {
  background: rgba(144, 202, 249, 0.65) !important; /* ü©µ Office ‚Äì soft blue */
  color: #000 !important;
}

.presence-wfh {
  background: rgba(227, 242, 253, 0.55) !important; /* ü©∂ WFH ‚Äì very light */
  color: #000 !important;
}

.presence-leave {
  background: rgba(239, 83, 80, 0.45) !important; /* üî¥ Leave ‚Äì red */
  color: #fff !important;
}

/* ‚ú® VISIT COLORS (Sheet1) ‚Äì softer fade version */
.cell-active {
  background: rgba(102, 187, 106, 0.35) !important;  /* üü¢ Active Visit ‚Äì faded green */
  color: #000 !important;
}

.cell-upcoming {
  background: rgba(255, 235, 59, 0.35) !important;   /* üü° Upcoming Visit ‚Äì faded yellow */
  color: #000 !important;
}

.cell-overdue {
  background: rgba(220, 53, 69, 0.45) !important;    /* üî¥ Overdue Visit ‚Äì slightly visible red */
  color: #fff !important;
}

/* ü©µ POSTPONED VISITS ‚Äî glassy diagonal stripe pattern */
.cell-postponed {
  background: repeating-linear-gradient(
    135deg,
    rgba(100, 181, 246, 0.25),       /* light sky blue stripe */
    rgba(100, 181, 246, 0.25) 8px,
    rgba(255, 255, 255, 0.4) 8px,
    rgba(255, 255, 255, 0.4) 16px
  ) !important;
  border: 1px dashed rgba(100, 181, 246, 0.8);
  color: #000 !important;
  background-size: 16px 16px;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}

@keyframes postponedShift {
  from { background-position: 0 0; }
  to { background-position: 32px 32px; }
}

.cell-postponed {
  animation: postponedShift 6s linear infinite;
}



</style>


  </style>
 </head>
 <body>
  <!-- Sidebar Layout -->
  <div class="d-flex" id="dashboardLayout">
   <!-- Sidebar -->
   <nav class="bg-dark text-white p-3" id="sidebarMenu" style="min-width:220px;">
    <h6 class="text-uppercase text-secondary mb-3">
     Menu
    </h6>
    <ul class="nav flex-column gap-2">
     <li>
      <a class="nav-link text-white fw-semibold" href="#" onclick="showPage('visitPage')">
       <i class="fas fa-map-marker-alt me-2">
       </i>
       Visit Page
      </a>
     </li>
     <li>
      <a class="nav-link text-white fw-semibold" href="#" onclick="showPage('workloadPage')">
       <i class="fas fa-calendar-week me-2">
       </i>
       Workload Page
      </a>
     </li>
    </ul>
   </nav>
   <!-- Main Content Area -->
   <div class="flex-grow-1 bg-light" id="mainContent" style="min-height:100vh; overflow-x:hidden;">
    <!-- Pages will be shown here -->
    <div class="page-section" id="visitPage">
     <!-- ‚úÖ Your existing filters + stat cards + charts + timeline go here -->
     <!-- Loading Overlay -->
     <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner-border text-primary" role="status">
       <span class="visually-hidden">
        Loading...
       </span>
      </div>
     </div>
     <!-- Header -->
     <div class="dashboard-header">
      <div class="container">
       <div class="row align-items-center">
        <div class="col-md-6">
         <h1>
          <i class="fas fa-hard-hat me-3">
          </i>
          Engineer Visit Dashboard
         </h1>
         <p class="lead">
          Real-time monitoring of field engineer activities
         </p>
        </div>
        <div class="col-md-6 text-md-end">
         <div class="btn-group">
          <button class="btn btn-outline-light" id="refreshData">
           <i class="fas fa-sync-alt me-2">
           </i>
           Refresh Data
          </button>
          <button class="btn btn-light" id="exportReport">
           <i class="fas fa-download me-2">
           </i>
           Export Report
          </button>
          <button class="btn btn-success" id="newVisitBtn">
           <i class="fas fa-plus me-2">
           </i>
           New Visit
          </button>
          <button class="btn btn-presence ms-2" id="engineerPresenceBtn" title="Engineer Presence">
           <i class="fas fa-user-check me-2">
           </i>
           Presence
          </button>
         </div>
        </div>
       </div>
      </div>
     </div>
     <div class="container">
      <!-- Filters -->
      <div class="filter-section mb-5 mt-2">
       <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-3">
        <!-- ‚úÖ Zone filter (first) -->
        <div class="col">
         <label class="form-label" for="zoneTopFilter">
          Zone
         </label>
         <select aria-label="Zone Filter" class="form-select" id="zoneTopFilter">
          <option value="">
           All Zones
          </option>
          <option value="AZ">
           AZ
          </option>
          <option value="EZ">
           EZ
          </option>
          <option value="NZ">
           NZ
          </option>
          <option value="SZ">
           SZ
          </option>
          <option value="WZ">
           WZ
          </option>
         </select>
        </div>
        <div class="col">
         <label class="form-label" for="engineerFilter">
          Engineer
         </label>
         <select aria-label="Engineer Filter" class="form-select" id="engineerFilter">
          <option value="">
           All Engineers
          </option>
         </select>
        </div>
        <div class="col">
         <label class="form-label" for="dateFilter">
          Date Range
         </label>
         <select aria-label="Date Range Filter" class="form-select" id="dateFilter">
          <option value="all">
           All Dates
          </option>
          <option value="week">
           This Week
          </option>
          <option value="month">
           This Month
          </option>
          <option value="quarter">
           This Quarter
          </option>
         </select>
        </div>
        <div class="col">
         <label class="form-label" for="statusFilter">
          Status
         </label>
         <select aria-label="Status Filter" class="form-select" id="statusFilter">
          <option value="">
           All Status
          </option>
          <option value="active">
           Active
          </option>
          <option value="upcoming">
           Upcoming
          </option>
          <option value="completed">
           Completed
          </option>
          <option value="cancelled">
           Cancelled
          </option>
          <option value="postponed">
           Postponed
          </option>
          <option value="extended">
           Extended
          </option>
          <option value="overdue">
           Overdue
          </option>
         </select>
        </div>
        <div class="col">
         <label class="form-label" for="customerFilter">
          Customer
         </label>
         <select aria-label="Customer Filter" class="form-select" id="customerFilter">
          <option value="">
           All Customers
          </option>
         </select>
        </div>
       </div>
       <!-- Stats Cards -->
       <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-6 g-3 mb-4 mt-4" id="statsCards">
        <!-- Populated dynamically -->
       </div>
       <!-- Charts and Tables -->
       <div class="row">
        <div class="col-lg-8">
         <div class="row">
          <!-- Visits by Engineer Chart -->
          <div class="col-md-6">
           <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
             <span>
              Visits by Engineer
             </span>
             <i class="fas fa-user-hard-hat text-secondary">
             </i>
            </div>
            <div class="card-body">
             <div class="chart-container">
              <canvas id="engineerChart">
              </canvas>
             </div>
            </div>
           </div>
          </div>
          <!-- Visits by Customer Chart -->
          <div class="col-md-6">
           <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
             <span>
              Visits by Customer
             </span>
             <i class="fas fa-building text-secondary">
             </i>
            </div>
            <div class="card-body">
             <div class="chart-container">
              <canvas id="customerChart">
              </canvas>
             </div>
            </div>
           </div>
          </div>
          <!-- Timeline Chart -->
          <div class="col-md-12">
           <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
             <span>
              Visit Timeline
             </span>
             <div class="d-flex align-items-center" style="gap:12px; font-size:0.85rem;">
              <span>
               <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#3498db;margin-right:5px;">
               </span>
               Normal
              </span>
              <span>
               <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:green;margin-right:5px;">
               </span>
               Today
              </span>
              <span>
               <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:orange;margin-right:5px;">
               </span>
               Selected
              </span>
             </div>
            </div>
            <div class="card-body">
             <div class="chart-container">
              <!-- Timeline chart wrapped for horizontal scroll -->
              <div class="timeline-scroll-wrapper" id="timelineScrollWrapper">
               <div id="timelineEChart" style="width:100%;height:350px;">
               </div>
              </div>
              <!-- Rich Tooltip Card -->
              <div id="timelineTooltipCard" style="display:none; position:absolute; z-index:2000; width:auto; min-width:250px; max-width:90%; 
            max-height:350px; overflow-y:auto; 
            background:white; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15); padding:10px; white-space:normal;">
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
        <!-- Right Column -->
        <div class="col-lg-4">
         <div aria-label="Zone and Status Filters for lists" class="mb-3" id="zoneStatusFilters">
          <label class="form-label mb-0" for="zoneFilter">
           Zone:
          </label>
          <select class="form-select form-select-sm" id="zoneFilter" style="width: auto;">
           <option value="all">
            All
           </option>
           <option value="AZ">
            AZ
           </option>
           <option value="EZ">
            EZ
           </option>
           <option value="NZ">
            NZ
           </option>
           <option value="SZ">
            SZ
           </option>
           <option value="WZ">
            WZ
           </option>
          </select>
          <label class="form-label mb-0" for="listStatusFilter">
           Status:
          </label>
          <select class="form-select form-select-sm" id="listStatusFilter" style="width: auto;">
           <option value="all">
            All
           </option>
           <option value="active">
            Active
           </option>
           <option value="cancelled">
            Cancelled
           </option>
           <option value="postponed">
            Postponed
           </option>
           <option value="completed">
            Completed
           </option>
           <option value="extended">
            Extended
           </option>
           <option value="overdue">
            Overdue
           </option>
          </select>
         </div>
         <div aria-label="Upcoming Visits List" class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
           <span>
            Upcoming Visits
           </span>
           <span class="badge bg-warning" id="upcomingCount">
            0
           </span>
          </div>
          <div class="card-body p-0">
           <div class="list-group list-group-flush" id="upcomingVisitsList" tabindex="0">
            <!-- Upcoming visits populate here -->
           </div>
          </div>
         </div>
         <div aria-label="Active Visits List" class="card" style="margin-top:16px;">
          <div class="card-header d-flex justify-content-between align-items-center">
           <span>
            Active Visits
           </span>
           <span class="badge bg-success" id="activeCount">
            0
           </span>
          </div>
          <div class="card-body p-0">
           <div class="list-group list-group-flush" id="activeVisitsList" tabindex="0">
            <!-- Active visits populate here -->
           </div>
          </div>
         </div>
        </div>
       </div>
       <!-- Data Table -->
       <div class="row mt-4">
        <div class="col-12">
         <div aria-label="All Engineer Visits Table" class="card">
          <div class="card-header d-flex align-items-center flex-wrap gap-3">
           <!-- Left: Title -->
           <h5 class="mb-0 flex-shrink-0">
            All Engineer Visits
           </h5>
           <!-- Middle: Search -->
           <div class="flex-grow-1">
            <input class="form-control form-control-sm" id="searchInput" placeholder="Search..." style="height: calc(2.4rem); min-width: 220px;" type="text"/>
           </div>
           <!-- Right: Filters -->
           <div class="d-flex align-items-center gap-2 flex-shrink-0">
            <select class="form-select form-select-sm" id="tableZoneFilter" style="width: 160px; height: calc(2.4rem);">
             <option value="all">
              All Zones
             </option>
             <option value="AZ">
              AZ
             </option>
             <option value="EZ">
              EZ
             </option>
             <option value="NZ">
              NZ
             </option>
             <option value="SZ">
              SZ
             </option>
             <option value="WZ">
              WZ
             </option>
            </select>
            <select class="form-select form-select-sm" id="tableStatusFilter" multiple="" style="width: 200px; height: calc(2.4rem);">
             <option value="active">
              Active
             </option>
             <option value="upcoming">
              Upcoming
             </option>
             <option value="cancelled">
              Cancelled
             </option>
             <option value="postponed">
              Postponed
             </option>
             <option value="completed">
              Completed
             </option>
             <option value="extended">
              Extended
             </option>
             <option value="overdue">
              Overdue
             </option>
            </select>
           </div>
          </div>
          <div class="card-body">
           <div class="table-responsive" tabindex="0">
            <table aria-describedby="tableDescription" class="table table-hover" id="visitsTable">
             <thead>
              <tr>
               <th scope="col">
                Engineer
               </th>
               <th scope="col">
                Customer
               </th>
               <th scope="col">
                Date of Requirement
               </th>
               <th scope="col">
                Plan of Deputation
               </th>
               <th scope="col">
                Visit End Date
               </th>
               <th scope="col">
                Duration
               </th>
               <th scope="col">
                Visit Place
               </th>
               <th scope="col">
                Purpose
               </th>
               <th scope="col">
                Status
               </th>
               <th scope="col">
                Zone
               </th>
               <th scope="col">
                Actions
               </th>
              </tr>
             </thead>
             <tbody>
              <!-- Populated dynamically -->
             </tbody>
            </table>
            <div class="visually-hidden" id="tableDescription">
             Table of all engineer visits with editable rows.
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
      <!-- Editable Visit Detail Card -->
      <div aria-label="Edit visit details" aria-live="polite" aria-modal="true" id="visitDetailCard" role="dialog" tabindex="-1">
       <h4>
        Visit Details
       </h4>
       <form id="visitForm">
        <label for="engineerNameInput">
         Engineer Name
        </label>
        <input id="engineerNameInput" list="engineerNameList" name="EngineerName" placeholder="Start typing engineer name..." required="" type="text"/>
        <datalist id="engineerNameList">
        </datalist>
        <label for="customerNameInput">
         Customer Name
        </label>
        <input id="customerNameInput" name="CustomerName" required="" type="text"/>
        <label for="zoneInput">
         Zone
        </label>
        <select id="zoneInput" name="Zone" required="">
         <option value="AZ">
          AZ
         </option>
         <option value="EZ">
          EZ
         </option>
         <option value="NZ">
          NZ
         </option>
         <option value="SZ">
          SZ
         </option>
         <option value="WZ">
          WZ
         </option>
        </select>
        <label for="durationInput">
         Duration
        </label>
        <input id="durationInput" name="Duration" type="text"/>
        <label for="dateRequirementInput">
         Date of Requirement
        </label>
        <input id="dateRequirementInput" name="DateOfRequirement" required="" type="date"/>
        <label for="planOfDeputationInput">
         Plan of Deputation
        </label>
        <input id="planOfDeputationInput" name="PlanOfDeputation" required="" type="date"/>
        <label for="visitPlaceInput">
         Visit Place
        </label>
        <input id="visitPlaceInput" name="VisitPlace" required="" type="text"/>
        <label for="visitInput">
         Visit
        </label>
        <input id="visitInput" name="Visit" required="" type="text"/>
        <label for="purposeInput">
         Purpose
        </label>
        <input id="purposeInput" name="Purpose" required="" type="text">
         <label for="statusInputSelect">
          Status
         </label>
         <select id="statusInputSelect" name="Status" required="">
          <option value="active">
           Active
          </option>
          <option value="cancelled">
           Cancelled
          </option>
          <option value="postponed">
           Postponed
          </option>
          <option value="completed">
           Completed
          </option>
          <option value="extended">
           Extended
          </option>
         </select>
         <label for="createdAtInput">
          Created At
         </label>
         <input id="createdAtInput" name="CreatedAt" readonly="" type="datetime-local">
          <input id="createdAtUTCInput" name="CreatedAtUTC" type="hidden"/>
          <label for="mscInput">
           Msc (Remark)
          </label>
          <textarea id="mscInput" name="Msc"></textarea>
          <label for="loggerInput">
           Logger (Daily Comments)
          </label>
          <textarea id="loggerInput" name="Logger"></textarea>
          <input id="visitIdInput" name="VisitId" type="hidden"/>
          <input id="etagInput" name="ETag" type="hidden"/>
          <div class="btn-group">
           <button class="btn btn-primary" id="submitButton" type="submit">
            Save &amp; Update
           </button>
           <button class="btn btn-secondary" id="cancelEditBtn" type="button">
            Cancel
           </button>
          </div>
         </input>
        </input>
       </form>
      </div>
      <!-- Settings Panel -->
      <div aria-label="Dashboard settings" aria-live="polite" aria-modal="true" id="settingsPanel" role="dialog" tabindex="-1">
       <h4>
        <i class="fas fa-cog me-2">
        </i>
        Dashboard Settings
       </h4>
       <form id="settingsForm">
        <label for="getEndpointInput">
         GET Endpoint URL
        </label>
        <input id="getEndpointInput" name="getEndpoint" placeholder="https://your-flow-get-endpoint" type="url"/ value="https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/bc59504f5a0c4ecab6fe04942dc86183/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=hVu_68SRCOXoG-C0DWs8fS2Grp6gyvuKgvUMgX8JOBc">
        <small class="form-text">
         URL for retrieving data from your Power Automate Flow
        </small>
        <label for="postEndpointInput">
         POST Endpoint URL
        </label>
        <input id="postEndpointInput" name="postEndpoint" placeholder="https://your-flow-post-endpoint" type="url"/ value="https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/bf7f334a3ba94a5286be86cb9ee17d83/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=PCKebL-Fa4G0j493Wpqm5DrIjBdC3rqKdYdG8AU2yhQ">
        <small class="form-text">
         URL for sending updates to your Power Automate Flow
        </small>
        <label for="createEndpointInput">
         CREATE Endpoint URL
        </label>
        <input id="createEndpointInput" name="createEndpoint" placeholder="https://your-flow-create-endpoint" type="url"/ value="https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/c3d0aa2a7a454bfa9219a94280619913/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=NXafOFYnl6Y1ocdNwX50_5Xeo7y7AUuzpITYibqMYh4">
        <small class="form-text">
         URL for creating new visits in your Power Automate Flow
        </small>
        <label for="refreshIntervalInput">
         Auto-refresh Interval (minutes)
        </label>
        <input id="refreshIntervalInput" max="60" min="1" name="refreshInterval" type="number" value="5"/>
        <small class="form-text">
         How often to automatically refresh data (0 to disable)
        </small>
        <label for="cacheDurationInput">
         Cache Duration (minutes)
        </label>
        <input id="cacheDurationInput" max="1440" min="1" name="cacheDuration" type="number" value="10"/>
        <small class="form-text">
         How long to keep data in local storage before refreshing
        </small>
        <hr/>
        <h5>
         Status Logic Settings
        </h5>
        <label for="overdueThresholdInput">
         Overdue Threshold (days)
        </label>
        <input id="overdueThresholdInput" max="365" min="1" name="overdueThreshold" type="number" value="14"/>
        <small class="form-text">
         Visits become overdue when Date of Requirement is older than this many days
        </small>
        <label for="includeTimeInDateComparison">
         Include time in date comparisons
        </label>
        <input id="includeTimeInDateComparison" name="includeTimeInDateComparison" type="checkbox"/>
        <small class="form-text">
         When unchecked, compares dates without time components
        </small>
        <div class="btn-group">
         <button class="btn btn-primary" type="submit">
          Save Settings
         </button>
         <button class="btn btn-secondary" id="cancelSettingsBtn" type="button">
          Cancel
         </button>
        </div>
       </form>
      </div>
      <!-- Settings Button -->
      <div class="settings-btn" id="settingsButton" title="Settings">
       <i class="fas fa-cog fa-lg">
       </i>
      </div>
      <!-- Toast Container for Notifications -->
      <div class="toast-container">
       <div aria-atomic="true" aria-live="assertive" class="toast" id="liveToast" role="alert">
        <div class="toast-header">
         <strong class="me-auto" id="toastTitle">
          Notification
         </strong>
         <button aria-label="Close" class="btn-close" data-bs-dismiss="toast" type="button">
         </button>
        </div>
        <div class="toast-body" id="toastMessage">
         <!-- Message will be inserted here -->
        </div>
       </div>
      </div>
     </div>
     <!-- end of visitPage -->
     <footer aria-label="Footer Information" class="mt-5 py-3 text-center text-muted">
      <p>
       Engineer Visit Dashboard ‚Ä¢ Updated:
       <span id="lastUpdated">
        -
       </span>
      </p>
     </footer>

<!-- üü¢ Workload Page -->
<div class="page-section d-none p-3" id="workloadPage">
  <h5>
    <i class="fas fa-calendar-week text-primary me-2"></i>
    Weekly Workload
  </h5>

  <div class="card shadow-sm">
    <!-- üîπ Header -->
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Engineer Workload Overview</h6>
	<div class="d-flex justify-content-center gap-2 w-100">
		<button class="btn btn-sm btn-outline-secondary" onclick="shiftWorkload(-14)">‚óÄ Prev</button>
		<button class="btn btn-sm btn-outline-primary" onclick="shiftWorkload(0)">Today</button>
		<button class="btn btn-sm btn-outline-secondary" onclick="shiftWorkload(14)">Next ‚ñ∂</button>
	</div>

    </div>

    <!-- üåà Smart Legend Bar -->
    <div id="dashboardLegend"
      style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;
             background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);
             border-radius:8px;padding:8px 12px;margin:10px;
             box-shadow:0 1px 4px rgba(0,0,0,0.08);font-size:13px;">

      <strong style="margin-right:6px;">Legend:</strong>

      <!-- Presence -->
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="width:16px;height:16px;border-radius:3px;background:#90caf9;"></span>
        Office
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="width:16px;height:16px;border-radius:3px;background:#e3f2fd;border:1px solid #cfd8dc;"></span>
        WFH
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="width:16px;height:16px;border-radius:3px;background:#ef5350;"></span>
        Leave
      </div>

      <!-- Visits -->
      <div style="display:flex;align-items:center;gap:4px;margin-left:10px;">
        <span style="width:16px;height:16px;border-radius:3px;background:rgba(102,187,106,0.35);"></span>
        Active
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="width:16px;height:16px;border-radius:3px;background:rgba(255,235,59,0.35);"></span>
        Upcoming
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="width:16px;height:16px;border-radius:3px;
               background:repeating-linear-gradient(135deg,
                 rgba(100,181,246,0.25),
                 rgba(100,181,246,0.25) 8px,
                 rgba(255,255,255,0.4) 8px,
                 rgba(255,255,255,0.4) 16px);
               border:1px dashed rgba(100,181,246,0.8);
               background-size:16px 16px;"></span>
        Postponed
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="width:16px;height:16px;border-radius:3px;background:rgba(76,175,80,0.3);"></span>
        Completed
      </div>
    </div>

    <!-- ‚úÖ Calendar grid container -->
    <div class="card-body p-2" id="workloadBoardContainer"
         style="min-height:500px; overflow:auto; background:#fff; border:1px solid #ddd;">
      <div class="text-center text-muted py-5">
        Loading workload data...
      </div>
    </div>
	
	<!-- Bottom Navigation Buttons -->
	<div class="d-flex justify-content-center gap-3 mt-3 mb-2">
		<button class="btn btn-sm btn-outline-secondary" onclick="shiftWorkload(-14)">‚óÄ Prev</button>
		<button class="btn btn-sm btn-outline-primary" onclick="shiftWorkload(0)">Today</button>
		<button class="btn btn-sm btn-outline-secondary" onclick="shiftWorkload(14)">Next ‚ñ∂</button>
	</div>

	
  </div>
</div>
<!-- end of mainContent -->
</div>
<!-- end of dashboardLayout -->


   <!-- Overlap Conflict Modal -->
   <div aria-hidden="true" aria-labelledby="overlapModalLabel" class="modal fade" id="overlapModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
     <div class="modal-content">
      <div class="modal-header bg-danger text-white">
       <h5 class="modal-title" id="overlapModalLabel">
        <i class="fas fa-exclamation-circle me-2">
        </i>
        Overlap Conflicts
       </h5>
       <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
       </button>
      </div>
      <div class="modal-body" id="overlapModalBody">
       <p class="text-muted mb-0">
        No conflicts detected.
       </p>
      </div>
     </div>
    </div>
   </div>
   <!-- Workload Summary Modal -->
   <div aria-hidden="true" aria-labelledby="workloadModalLabel" class="modal fade" id="workloadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
     <div class="modal-content">
      <div class="modal-header bg-primary text-white">
       <h5 class="modal-title" id="workloadModalLabel">
        <i class="fas fa-chart-bar me-2">
        </i>
        Weekly Workload Summary
       </h5>
       <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
       </button>
      </div>
      <div class="modal-body" id="workloadModalBody">
       <p class="text-muted mb-0">
        No workload data available.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div id="workloadTooltip" style="display:none; position:fixed; z-index:2000; background:white; border:1px solid #ccc; 
            box-shadow:0 4px 10px rgba(0,0,0,0.15); padding:10px; border-radius:8px; 
            font-size:0.85rem; max-width:280px;">
   </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js">
  </script>
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js">
  </script>
  <!-- === Engineer Presence Card === -->
  <div id="presenceDetailCard" style="display:none; position:fixed; top:60px; right:20px; width:360px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3); z-index:1060;">
   <h4 id="presenceCardTitle">
    Engineer Presence
   </h4>
   <form id="presenceForm">
    <label>
     Engineer Name
    </label>
    <input id="presenceEngineerInput" list="engineerNameList" required="" type="text"/>
    <label>
     From Date
    </label>
    <input id="presenceFromInput" required="" type="date"/>
    <label>
     To Date
    </label>
    <input id="presenceToInput" required="" type="date"/>
    <label>
     Type
    </label>
    <select id="presenceTypeSelect" required="">
     <option value="leave">
      Leave
     </option>
     <option value="office">
      In Office
     </option>
     <option value="wfh">
      Work from Home
     </option>
    </select>
    <label>
     Note
    </label>
    <textarea id="presenceNoteInput" placeholder="Optional" rows="3"></textarea>
    <input id="presenceIdInput" type="hidden"/>
    <div style="margin-top:10px; display:flex; gap:10px;">
     <button class="btn btn-primary" type="submit">
      Save
     </button>
     <button class="btn btn-secondary" id="cancelPresenceBtn" type="button">
      Cancel
     </button>
     <button class="btn btn-danger" id="deletePresenceBtn" style="margin-left:auto; display:none;" type="button">
      Delete
     </button>
    </div>
   </form>
  </div>
  <script>
   // ====== Engineer Presence System ======
      
let allPresences = JSON.parse(localStorage.getItem('cachedPresencesData') || '[]');
function savePresences() { localStorage.setItem('cachedPresencesData', JSON.stringify(allPresences)); }
function createNewPresence() {
  const today = new Date().toISOString().slice(0,10);
  return { PresenceId: 'p_' + Date.now(), EngineerName: '', FromDate: today, ToDate: today, PresenceType: 'leave', Note: '' };
}
function showPresenceCard(p, isNew=false) {
  document.getElementById('presenceCardTitle').textContent = isNew ? 'Add Presence' : 'Edit Presence';
  document.getElementById('presenceEngineerInput').value = p.EngineerName;
  document.getElementById('presenceFromInput').value = p.FromDate;
  document.getElementById('presenceToInput').value = p.ToDate;
  document.getElementById('presenceTypeSelect').value = p.PresenceType;
  document.getElementById('presenceNoteInput').value = p.Note;
  document.getElementById('presenceIdInput').value = p.PresenceId;
  document.getElementById('deletePresenceBtn').style.display = isNew ? 'none' : 'inline-block';
  document.getElementById('presenceDetailCard').style.display = 'block';
}
function hidePresenceCard() { document.getElementById('presenceDetailCard').style.display = 'none'; }
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('engineerPresenceBtn');
  if (btn) btn.addEventListener('click', () => { showPresenceCard(createNewPresence(), true); });
  document.getElementById('cancelPresenceBtn').addEventListener('click', hidePresenceCard);
  document.getElementById('presenceForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = document.getElementById('presenceIdInput').value || ('p_' + Date.now());
    const rec = {
      PresenceId: id,
      EngineerName: document.getElementById('presenceEngineerInput').value.trim(),
      FromDate: document.getElementById('presenceFromInput').value,
      ToDate: document.getElementById('presenceToInput').value,
      PresenceType: document.getElementById('presenceTypeSelect').value,
      Note: document.getElementById('presenceNoteInput').value.trim()
    };
    const idx = allPresences.findIndex(p => p.PresenceId === id);
    if (idx >= 0) allPresences[idx] = rec; else allPresences.push(rec);
    savePresences(); hidePresenceCard(); renderWorkloadCalendar(window.allVisits || []);
  });
  document.getElementById('deletePresenceBtn').addEventListener('click', () => {
    const id = document.getElementById('presenceIdInput').value;
    allPresences = allPresences.filter(p => p.PresenceId !== id);
    savePresences(); hidePresenceCard(); renderWorkloadCalendar(window.allVisits || []);
  });
});
  </script>
 

<!-- Unified Presence Endpoint Integration -->
<script>

// ü™Ñ Preload presence endpoint BEFORE DOMContentLoaded
if (!window.settings) window.settings = {};
const savedPresence = localStorage.getItem("presenceEndpoint");
if (savedPresence) {
  window.settings.presenceEndpoint = savedPresence;
  console.log("ü™Ñ Preloaded presence endpoint from localStorage:", savedPresence);
}


document.addEventListener('DOMContentLoaded', () => {
  const presenceEndpointInput = document.createElement('div');
  presenceEndpointInput.innerHTML = `
    <hr/>
    <h5>Presence (Sheet2) Unified Endpoint</h5>
    <label for="presenceEndpointInput">Presence Endpoint URL</label>
    <input id="presenceEndpointInput" name="presenceEndpoint" type="url"
      placeholder="https://your-flow-presence-endpoint" class="form-control"/ value="https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/e6bc1fc9bd0740829ca2e0cde9167545/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ucumwvmShBHRqgHTSehFRqoG_za8ox6etFeAiIsj-us">
    <small class="form-text">Single endpoint handling GET / SAVE / DELETE Presence</small>`;
  const form = document.getElementById('settingsForm');
  const ref = document.getElementById('refreshIntervalInput');
  if (form && ref) ref.parentNode.insertBefore(presenceEndpointInput, ref);

  // Load/save field in settings
  if (window.settings && settings.presenceEndpoint)
    document.getElementById('presenceEndpointInput').value = settings.presenceEndpoint;
});

// ====== DEEP DEBUG VERSION ======
async function presenceAPI(action, payload = {}) {
  const endpointEl = document.getElementById('presenceEndpointInput');
  let finalEndpoint =
    (window.settings && settings.presenceEndpoint) ||
    (endpointEl ? endpointEl.value : "") ||
    localStorage.getItem("presenceEndpoint") || "";

  if (!finalEndpoint) {
    if (action === "get") {
      console.warn("üö´ Skipping early GET ‚Äî endpoint not yet ready.");
      return [];
    } else {
      alert("Presence endpoint not set");
      return [];
    }
  }

  const url = finalEndpoint;
  const bodyData = JSON.stringify({ action, data: payload });

  console.group("üåê Presence API Debug");
  console.log("üîó Endpoint:", url);
  console.log("‚û°Ô∏è Action:", action);
  console.log("üì¶ Payload:", payload);
  console.log("üßæ Request body JSON:", bodyData);


  try {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: bodyData,
    });

    console.log("üì° HTTP Status:", res.status, res.statusText);
    console.log("üì° Response Headers:", Object.fromEntries(res.headers.entries()));

    // Check if the browser blocked access to body due to CORS
    let text;
    try {
      text = await res.text();
    } catch (readErr) {
      console.error("üö´ Failed to read response body (possible CORS block):", readErr);
      console.groupEnd();
      return [];
    }

    console.log("üìú Raw Response Text:", text);

    // Try parsing JSON
    let data;
    try {
      data = JSON.parse(text);
      console.log("‚úÖ Parsed JSON:", data);
    } catch (jsonErr) {
      console.error("‚ö†Ô∏è JSON parse failed, raw text returned instead.");
      console.groupEnd();
      return [];
    }

    // Auto-detect response format
    let rows;
    if (Array.isArray(data)) {
      rows = data;
      console.log("‚úÖ Detected plain array:", rows.length, "rows");
    } else if (Array.isArray(data.value)) {
      rows = data.value;
      console.log("‚úÖ Detected 'value' array:", rows.length, "rows");
    } else if (Array.isArray(data.rows)) {
      rows = data.rows;
      console.log("‚úÖ Detected 'rows' array:", rows.length, "rows");
    } else {
      console.warn("‚ö†Ô∏è Unexpected data format:", data);
      rows = [];
    }

    console.groupEnd();
    return rows;

  } catch (err) {
    console.error("‚ùå Presence API fetch failed:", err);
    console.groupEnd();
    return [];
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  if (!window.settings) window.settings = {}; // safety guard

  // ‚úÖ Step 1: Always check both settings and localStorage
  const savedPresence = localStorage.getItem("presenceEndpoint");
  if (savedPresence) {
    window.settings.presenceEndpoint = savedPresence;
    console.log("ü™Ñ Preloaded presence endpoint from localStorage:", savedPresence);
  }

  // ‚úÖ Step 2: Wait until the settings panel has actually inserted the input box
  let tries = 0;
  while ((!document.getElementById("presenceEndpointInput") ||
          !window.settings.presenceEndpoint) && tries < 20) {
    await new Promise(r => setTimeout(r, 250)); // wait ¬º second
    tries++;
  }
  console.log("‚öôÔ∏è Presence endpoint ready:", window.settings.presenceEndpoint || "none");

  // ‚úÖ Step 3: Now load presence data
  await loadPresenceData();

  // ‚úÖ Step 4: If still empty, retry once after 2 s
  if (!allPresences || allPresences.length === 0) {
    setTimeout(async () => {
      if (window.settings.presenceEndpoint) {
        console.log("üîÅ Retrying presence data load (endpoint now ready)...");
        await loadPresenceData();
      } else {
        console.warn("‚ö†Ô∏è Still no presence endpoint available, skipping retry.");
      }
    }, 2000);
  }
});



async function loadPresenceData() {
  allPresences = await presenceAPI("get");
  console.log("‚úÖ Presence data fetched:", allPresences);   // üëà ADD THIS
  localStorage.setItem("cachedPresencesData", JSON.stringify(allPresences));
  if (typeof renderWorkloadCalendar === "function")
    renderWorkloadCalendar(window.allVisits || []);
}

async function savePresence(p) {
  await presenceAPI("save", p);
  showToast("Presence Saved", `${p.EngineerName} - ${p.PresenceType}`);
  await loadPresenceData();
}

async function deletePresence(presenceId) {
  await presenceAPI("delete", { PresenceId: presenceId });
  await loadPresenceData();
}

document.addEventListener('DOMContentLoaded', () => {
  const pf = document.getElementById('presenceForm');
  if (pf) pf.addEventListener('submit', async e => {
    e.preventDefault();
    const rec = {
      PresenceId: document.getElementById('presenceIdInput').value || 'p_' + Date.now(),
      EngineerName: document.getElementById('presenceEngineerInput').value.trim(),
      FromDate: document.getElementById('presenceFromInput').value,
      ToDate: document.getElementById('presenceToInput').value,
      PresenceType: document.getElementById('presenceTypeSelect').value,
      Note: document.getElementById('presenceNoteInput').value.trim()
    };
    await savePresence(rec);
    hidePresenceCard();
  });

  const delBtn = document.getElementById('deletePresenceBtn');
  if (delBtn) delBtn.addEventListener('click', async () => {
    const id = document.getElementById('presenceIdInput').value;
    await deletePresence(id);
    hidePresenceCard();
  });

  // Double-click workload to open presence edit
  document.addEventListener('dblclick', function(e) {
    const cell = e.target.closest('.workload-cell');
    if (!cell) return;
    const engineer = cell.getAttribute('data-engineer') || cell.dataset.engineer;
    const date = cell.getAttribute('data-date') || cell.dataset.date;
    if (!engineer || !date) return;
    const match = allPresences.find(p => {
      const from = p.FromDate?.slice(0,10);
      const to = p.ToDate?.slice(0,10);
      const d = date.slice(0,10);
      return p.EngineerName === engineer && from && to && d >= from && d <= to;
    });
    if (match) showPresenceCard(match, false);
    else {
      const np = createNewPresence();
      np.EngineerName = engineer;
      np.FromDate = date;
      np.ToDate = date;
      showPresenceCard(np, true);
    }
  });

  // Load on start
  // loadPresenceData();
});
</script>

</body>
</html>
<script>
 /*
         * Configuration: Default settings that can be changed via the settings panel
         */
        const defaultSettings = {
    getEndpoint: "https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/bc59504f5a0c4ecab6fe04942dc86183/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=hVu_68SRCOXoG-C0DWs8fS2Grp6gyvuKgvUMgX8JOBc",
    postEndpoint: "https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/bf7f334a3ba94a5286be86cb9ee17d83/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=PCKebL-Fa4G0j493Wpqm5DrIjBdC3rqKdYdG8AU2yhQ",
    createEndpoint: "https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/c3d0aa2a7a454bfa9219a94280619913/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=NXafOFYnl6Y1ocdNwX50_5Xeo7y7AUuzpITYibqMYh4",
    presenceEndpoint: "https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/e6bc1fc9bd0740829ca2e0cde9167545/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ucumwvmShBHRqgHTSehFRqoG_za8ox6etFeAiIsj-us",
    refreshInterval: 5,
    cacheDuration: 10,
    overdueThreshold: 14,
    includeTimeInDateComparison: false
};

        // Current settings (will be loaded from localStorage)
        let settings = {...defaultSettings};
        let refreshTimer = null;

        /*
         * State variables
         */
        let allVisits = [];
		 //  let allPresences = [];
        let filteredVisits = [];
        let charts = {
            engineerChart: null,
            customerChart: null,
            timelineChart: null
        };

        /*
         * DOM references for convenience
         */
        const engineerFilterEl = document.getElementById("engineerFilter");
        const customerFilterEl = document.getElementById("customerFilter");
        const dateFilterEl = document.getElementById("dateFilter");
        const statusFilterEl = document.getElementById("statusFilter");
        const zoneFilterEl = document.getElementById("zoneFilter");
        const listStatusFilterEl = document.getElementById("listStatusFilter");
        const tableZoneFilterEl = document.getElementById("tableZoneFilter");
        const tableStatusFilterEl = document.getElementById("tableStatusFilter");
        const searchInputEl = document.getElementById("searchInput");

        /*
         * Initialize dashboard on DOM ready
         */
        document.addEventListener("DOMContentLoaded", async () => {
            // Load settings from localStorage
            loadSettings();
            
            // Apply settings to form
            document.getElementById("getEndpointInput").value = settings.getEndpoint;
            document.getElementById("postEndpointInput").value = settings.postEndpoint;
			document.getElementById("createEndpointInput").value = settings.createEndpoint;
            document.getElementById("refreshIntervalInput").value = settings.refreshInterval;
            document.getElementById("cacheDurationInput").value = settings.cacheDuration;
            document.getElementById("overdueThresholdInput").value = settings.overdueThreshold;
            document.getElementById("includeTimeInDateComparison").checked = settings.includeTimeInDateComparison;
            
			// Load unified Presence endpoint
			if (document.getElementById("presenceEndpointInput"))
				document.getElementById("presenceEndpointInput").value = settings.presenceEndpoint || "";

            // Setup auto-refresh if enabled
            setupAutoRefresh();
            
            // Try to load data from cache first
            const cachedData = loadFromCache();
            if (cachedData && cachedData.length > 0) {
                allVisits = cachedData;
                applyFiltersAndRender();
                showToast("Success", "Loaded cached data");
                hideLoadingOverlay();
            }
            
            // Then try to fetch fresh data
            await loadDataFromEndpoint();
            
            setupEventListeners();
        });

        /*
         * Load settings from localStorage
         */
        function loadSettings() {
            const savedSettings = localStorage.getItem("dashboardSettings");
            if (savedSettings) {
                try {
                    settings = {...defaultSettings, ...JSON.parse(savedSettings)};
                } catch (e) {
                    console.error("Error loading settings:", e);
                    settings = {...defaultSettings};
                }
            } else {
                settings = {...defaultSettings};
            }
        }

        /*
         * Save settings to localStorage
         */
        function saveSettings(newSettings) {
            settings = {...settings, ...newSettings};
            localStorage.setItem("dashboardSettings", JSON.stringify(settings));
            
            // Update auto-refresh timer
            setupAutoRefresh();
            
            // Recompute statuses for all visits with new settings
            allVisits.forEach(visit => {
                visit.computedStatus = getComputedStatus(visit);
            });
            
            // Re-render everything
            applyFiltersAndRender();
            
            showToast("Success", "Settings saved successfully");
        }

        /*
         * Setup auto-refresh based on settings
         */
        function setupAutoRefresh() {
            // Clear existing timer
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            // Set up new timer if interval is > 0
            if (settings.refreshInterval > 0) {
                refreshTimer = setInterval(async () => {
                    await loadDataFromEndpoint();
                    showToast("Info", "Data refreshed automatically");
                }, settings.refreshInterval * 60 * 1000);
            }
        }

        /*
         * Show/hide loading overlay
         */
        function showLoadingOverlay() {
            document.getElementById("loadingOverlay").style.display = "flex";
        }
        
        function hideLoadingOverlay() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        /*
         * Load data from cache with timestamp validation
         */
        function loadFromCache() {
            const cached = localStorage.getItem("cachedVisitsData");
            const timestamp = localStorage.getItem("cachedVisitsTimestamp");
            
            if (!cached || !timestamp) return null;
            
            // Check if cache is still valid
            const now = new Date().getTime();
            const cacheTime = parseInt(timestamp);
            const cacheDurationMs = settings.cacheDuration * 60 * 1000;
            
            if (now - cacheTime > cacheDurationMs) {
                // Cache expired
                return null;
            }
            
            try {
                return JSON.parse(cached);
            } catch (e) {
                console.error("Error parsing cached data:", e);
                return null;
            }
        }

        /*
         * Save data to cache with timestamp
         */
        function saveToCache(data) {
            try {
                localStorage.setItem("cachedVisitsData", JSON.stringify(data));
                localStorage.setItem("cachedVisitsTimestamp", new Date().getTime().toString());
            } catch (e) {
                console.error("Error saving to cache:", e);
            }
        }

        /*
         * Parse dates from SharePoint/Excel, handling both serial numbers and string formats
         */
        function parseSharePointDate(dateValue) {
            if (!dateValue) return null;
            
            // 1. Handle Excel serial numbers (like "45888")
            if (typeof dateValue === 'string' && /^\d+$/.test(dateValue)) {
                const serialNumber = parseInt(dateValue);
                // Excel's base date is January 1, 1900 (with 1900 incorrectly treated as a leap year)
                const baseDate = new Date(1900, 0, 1);
                // Subtract 2 days to correct for Excel's leap year error and 1900 base
                const correctedDate = new Date(baseDate.getTime() + (serialNumber - 2) * 24 * 60 * 60 * 1000);
                return correctedDate;
            }
            
            // 2. If it's already a proper date string with timezone info
            if (dateValue.includes('T') || dateValue.includes('Z')) {
                return new Date(dateValue);
            }
            
            // 3. Handle SharePoint date format (MM/DD/YYYY) as a fallback
            const parts = dateValue.split('/');
            if (parts.length === 3) {
                // Note: month is 0-indexed in JavaScript Date
                return new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
            }
            
            // 4. Final fallback to default date parsing
            return new Date(dateValue);
        }

        /*
         * Format date for display (MM/DD/YYYY)
         */
        function formatDateForDisplay(date) {
            if (!date) return '';
            
            const dateObj = parseSharePointDate(date);
            if (isNaN(dateObj.getTime())) return '';
            
            return `${dateObj.getMonth() + 1}/${dateObj.getDate()}/${dateObj.getFullYear()}`;
        }

        /*
         * Format date for input field (YYYY-MM-DD)
         */
        function formatDateForInput(date) {
            if (!date) return '';
            
            const dateObj = parseSharePointDate(date);
            if (isNaN(dateObj.getTime())) return '';
            
            const year = dateObj.getFullYear();
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        /*
         * Compute status based on business rules and settings
         */


		function calculateVisitEndDate(planDateStr, durationStr) {
			try {
				const planDateRaw = parseSharePointDate(planDateStr);
				if (!planDateRaw || isNaN(planDateRaw.getTime())) return '';

				// Normalize to local midnight to avoid timezone offsets shifting the day
				const planDate = new Date(planDateRaw.getFullYear(), planDateRaw.getMonth(), planDateRaw.getDate());

				// Extract integer part of duration (handles "2", "2 days", "2d", etc.)
				const match = (durationStr || '').toString().trim().match(/-?\d+/);
				const duration = match ? parseInt(match[0], 10) : 0;

				// Make duration inclusive of the start day:
				// duration = 1 -> add 0 days (same day), duration = 2 -> add 1 day, etc.
				const addDays = Math.max(0, duration - 1);

				const endDate = new Date(planDate);
				endDate.setDate(endDate.getDate() + addDays);

				const mm = (endDate.getMonth() + 1).toString().padStart(2, '0');
				const dd = endDate.getDate().toString().padStart(2, '0');
				const yyyy = endDate.getFullYear();

				return `${mm}/${dd}/${yyyy}`;
			} catch (e) {
				console.error('calculateVisitEndDate error', e);
				return '';
			}
		}
        

		function getComputedStatus(visit) {
			const status = visit.Status ? visit.Status.toLowerCase() : '';
			const planDate = parseSharePointDate(visit.PlanOfDeputation);
			const requirementDate = parseSharePointDate(visit.DateOfRequirement);

			const today = new Date();
			if (!settings.includeTimeInDateComparison) {
				today.setHours(0, 0, 0, 0);
				if (planDate) planDate.setHours(0, 0, 0, 0);
				if (requirementDate) requirementDate.setHours(0, 0, 0, 0);
			}

			// explicit overrides
			if (status === 'completed') return 'completed';
			if (status === 'cancelled') return 'cancelled';
			if (status === 'postponed') return 'postponed';
			if (status === 'extended') return 'extended';

			// overdue (unchanged)
			if (requirementDate && !isNaN(requirementDate.getTime())) {
				const diffTime = today - requirementDate;
				const diffDays = diffTime / (1000 * 60 * 60 * 24);
				if (requirementDate < today && diffDays > settings.overdueThreshold) {
					return 'overdue';
				}
			}

			// Determine using planDate AND endDate (new behavior)
			if (planDate && !isNaN(planDate.getTime())) {
				const endDateStr = calculateVisitEndDate(visit.PlanOfDeputation, visit.Duration);
				const endDate = parseSharePointDate(endDateStr);

				if (endDate && !isNaN(endDate.getTime())) {
					if (planDate > today) return 'upcoming';
					if (today >= planDate && today <= endDate) return 'active';
					if (today > endDate) return 'completed'; // visit finished
				} else {
					// fallback when duration/endDate missing
					if (planDate > today) return 'upcoming';
					if (planDate <= today) return 'active';
				}
			}

			return 'unknown';
		}


        /*
         * Get status badge class based on computed status
         */
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'bg-success';
                case 'upcoming': return 'bg-warning';
                case 'completed': return 'bg-secondary';
                case 'cancelled': return 'bg-danger';
                case 'postponed': return 'bg-info';
                case 'extended': return 'bg-purple';
                case 'overdue': return 'bg-overdue';
                default: return 'bg-secondary';
            }
        }

        /*
         * Load data from the configured endpoint
         */
        async function loadDataFromEndpoint() {
            if (!settings.getEndpoint) {
                showToast("Error", "GET endpoint not configured. Please set it in Settings.");
                hideLoadingOverlay();
                return;
            }
            
            showLoadingOverlay();
            
            try {
                const response = await fetch(settings.getEndpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Process the data
                allVisits = data.value.map(item => {
                    // Compute status for each visit
                    const computedStatus = getComputedStatus(item);
                    
                    return {
                        ...item,
                        computedStatus: computedStatus
                    };
                });
                
                // Save to cache
                saveToCache(allVisits);
                
                // Update UI
                applyFiltersAndRender();
                
                // Update last updated timestamp
                document.getElementById("lastUpdated").textContent = new Date().toLocaleString();
                
                showToast("Success", `Loaded ${allVisits.length} visits`);
            } catch (error) {
                console.error("Error fetching data:", error);
                showToast("Error", "Failed to fetch data. Using cached data if available.");
                
                // Try to use cached data if fetch failed
                const cachedData = loadFromCache();
                if (cachedData && cachedData.length > 0) {
                    allVisits = cachedData;
                    applyFiltersAndRender();
                }
            } finally {
                hideLoadingOverlay();
            }
        }

		/*
		 * Create a new empty visit object
		 */
		function createNewVisit() {
			const now = new Date();
			const formattedDate = now.toISOString(); // Full ISO string for CreatedAt
			const todayFormatted = `${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()}`; // MM/DD/YYYY for date fields
			
			return {
				EngineerName: '',
				CustomerName: '',
				DateOfRequirement: todayFormatted, // Use MM/DD/YYYY format
				PlanOfDeputation: todayFormatted,  // Use MM/DD/YYYY format
				Duration: '',
				VisitPlace: '',
				Visit: '',
				Purpose: '',
				Status: 'active',
				Zone: 'AZ',
				Msc: '',
				Logger: '',
				CreatedAt: now.toISOString(), // Full ISO string for identification
				computedStatus: 'upcoming'
			};
		}

        /*
         * Apply all filters and render the dashboard
         */
        function applyFiltersAndRender() {
		    // üîπ Make the visit data globally accessible for Smart Planning (overlap & workload)
			window.allVisits = allVisits;
		
            // Apply filters
            filteredVisits = filterVisits(allVisits);
            
            // Update stats
            updateStatsCards(filteredVisits);
            
            // Update lists
            updateVisitLists(filteredVisits);
            
            // Update table
            updateVisitsTable(filteredVisits);
            
            // Update charts
            updateCharts(filteredVisits);
            
            // Update filter dropdowns
            updateFilterDropdowns(filteredVisits);

// ‚úÖ Populate datalist for Engineer Name suggestions (for Add/Edit form)
const engineerNameListEl = document.getElementById('engineerNameList');
if (engineerNameListEl && allVisits.length > 0) {
  const uniqueNames = [...new Set(allVisits.map(v => v.EngineerName).filter(Boolean).sort())];
  engineerNameListEl.innerHTML = uniqueNames.map(n => `<option value="${n}">`).join('');
}
			
			  // ‚úÖ Update Workload board (fixed variable)
			renderWorkloadCalendar(filteredVisits);

        }

        /*
         * Filter visits based on all active filters
         */
        function filterVisits(visits) {
            let filtered = [...visits];
            
            // Engineer filter
            const engineerFilter = engineerFilterEl.value;
            if (engineerFilter) {
                filtered = filtered.filter(v => v.EngineerName === engineerFilter);
            }
            
            // Customer filter
            const customerFilter = customerFilterEl.value;
            if (customerFilter) {
                filtered = filtered.filter(v => v.CustomerName === customerFilter);
            }
            
            // Status filter
            const statusFilter = statusFilterEl.value;
            if (statusFilter) {
                filtered = filtered.filter(v => v.computedStatus === statusFilter);
            }
			// ‚úÖ Zone filter (new top filter)
			const zoneTopFilter = document.getElementById("zoneTopFilter").value;
			if (zoneTopFilter) {
				filtered = filtered.filter(v => v.Zone && v.Zone.toLowerCase() === zoneTopFilter.toLowerCase());
			}

            // Date filter
            const dateFilter = dateFilterEl.value;
            if (dateFilter !== 'all') {
                const now = new Date();
                let startDate;
                
                switch (dateFilter) {
                    case 'week':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }
                
                filtered = filtered.filter(v => {
                    const planDate = parseSharePointDate(v.PlanOfDeputation);
                    return planDate && planDate >= startDate;
                });
            }
            
            return filtered;
        }

        /*
         * Update stats cards with current data
         */
		function updateStatsCards(visits) {
			const stats = {
				total: visits.length,
				active: visits.filter(v => v.computedStatus === 'active').length,
				upcoming: visits.filter(v => v.computedStatus === 'upcoming').length,
				overdue: visits.filter(v => v.computedStatus === 'overdue').length
			};
			
			const statsCardsHtml = `
				<div class="col-md-3 col-6 mb-3">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<h6 class="text-muted">Total Visits</h6>
								<div class="stat-number">${stats.total}</div>
							</div>
							<div class="stat-icon">
								<i class="fas fa-list"></i>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-3 col-6 mb-3">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<h6 class="text-muted">Active</h6>
								<div class="stat-number">${stats.active}</div>
							</div>
							<div class="stat-icon">
								<i class="fas fa-play-circle"></i>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-3 col-6 mb-3">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<h6 class="text-muted">Upcoming</h6>
								<div class="stat-number">${stats.upcoming}</div>
							</div>
							<div class="stat-icon">
								<i class="fas fa-clock"></i>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-3 col-6 mb-3">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<h6 class="text-muted">Overdue</h6>
								<div class="stat-number">${stats.overdue}</div>
							</div>
							<div class="stat-icon">
								<i class="fas fa-exclamation-triangle"></i>
							</div>
						</div>
					</div>
				</div>
			`;
			
			document.getElementById("statsCards").innerHTML = statsCardsHtml;
		}


        /*
         * Update the visit lists (upcoming and active)
         */
        function updateVisitLists(visits) {
            // Get zone and status filters for lists
            const zoneFilter = zoneFilterEl.value;
            const statusFilter = listStatusFilterEl.value;
            
            // Filter visits for lists
            let listVisits = [...visits];
            if (zoneFilter !== 'all') {
                listVisits = listVisits.filter(v => v.Zone === zoneFilter);
            }
            if (statusFilter !== 'all') {
                listVisits = listVisits.filter(v => v.computedStatus === statusFilter);
            }
            
            // Separate upcoming and active visits
            const upcomingVisits = listVisits.filter(v => v.computedStatus === 'upcoming')
                .sort((a, b) => {
                    const aDate = parseSharePointDate(a.PlanOfDeputation);
                    const bDate = parseSharePointDate(b.PlanOfDeputation);
                    return aDate - bDate;
                })
                .slice(0, 5); // Top 5
            
            const activeVisits = listVisits.filter(v => v.computedStatus === 'active')
                .sort((a, b) => {
                    const aDate = parseSharePointDate(a.PlanOfDeputation);
                    const bDate = parseSharePointDate(b.PlanOfDeputation);
                    return aDate - bDate;
                })
                .slice(0, 5); // Top 5
            
            // Update counts
            document.getElementById("upcomingCount").textContent = upcomingVisits.length;
            document.getElementById("activeCount").textContent = activeVisits.length;
            
            // Render upcoming visits list
            const upcomingListHtml = upcomingVisits.map(visit => `
                <a href="#" class="list-group-item list-group-item-action" data-id="${visit.ID || visit.VisitId}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${visit.CustomerName || 'Unknown Customer'}</h6>
                        <small>${formatDateForDisplay(visit.PlanOfDeputation)}</small>
                    </div>
                    <p class="mb-1">${visit.EngineerName || 'Unknown Engineer'}</p>
                    <small class="text-muted">${visit.Purpose || 'No purpose specified'}</small>
                </a>
            `).join('');
            
            document.getElementById("upcomingVisitsList").innerHTML = upcomingVisits.length > 0 ? 
                upcomingListHtml : 
                '<div class="list-group-item text-center text-muted">No upcoming visits</div>';
            
            // Render active visits list
            const activeListHtml = activeVisits.map(visit => `
                <a href="#" class="list-group-item list-group-item-action" data-id="${visit.ID || visit.VisitId}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${visit.CustomerName || 'Unknown Customer'}</h6>
                        <small>${formatDateForDisplay(visit.PlanOfDeputation)}</small>
                    </div>
                    <p class="mb-1">${visit.EngineerName || 'Unknown Engineer'}</p>
                    <small class="text-muted">${visit.Purpose || 'No purpose specified'}</small>
                </a>
            `).join('');
            
            document.getElementById("activeVisitsList").innerHTML = activeVisits.length > 0 ? 
                activeListHtml : 
                '<div class="list-group-item text-center text-muted">No active visits</div>';
            
            // Add click handlers to list items
            document.querySelectorAll('#upcomingVisitsList a, #activeVisitsList a').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const visitId = item.getAttribute('data-id');
                    const visit = allVisits.find(v => (v.ID || v.VisitId) == visitId);
                    if (visit) {
                        showVisitDetails(visit);
                    }
                });
            });
        }

        /*
         * Update the main visits table
         */
        function updateVisitsTable(visits) {
            // Get table filters
			// Multi-select friendly
			const selectedZones = Array.from(tableZoneFilterEl.selectedOptions).map(opt => opt.value);
			const selectedStatuses = Array.from(tableStatusFilterEl.selectedOptions).map(opt => opt.value);
			const searchTerm = searchInputEl.value.toLowerCase();

			// Filter visits for table
			let tableVisits = [...visits];

			// Zone filter (if something selected)
			if (selectedZones.length > 0 && !selectedZones.includes("all")) {
				tableVisits = tableVisits.filter(v => selectedZones.includes(v.Zone));
			}

			// Status filter (if something selected)
			if (selectedStatuses.length > 0 && !selectedStatuses.includes("all")) {
				tableVisits = tableVisits.filter(v => selectedStatuses.includes(v.computedStatus));
			}

            
            if (searchTerm) {
                tableVisits = tableVisits.filter(v => 
                    (v.EngineerName && v.EngineerName.toLowerCase().includes(searchTerm)) ||
                    (v.CustomerName && v.CustomerName.toLowerCase().includes(searchTerm)) ||
                    (v.VisitPlace && v.VisitPlace.toLowerCase().includes(searchTerm)) ||
                    (v.Purpose && v.Purpose.toLowerCase().includes(searchTerm))
                );
            }
            
			// Generate table rows
			const tableBodyHtml = tableVisits.map(visit => {
				const statusClass = getStatusBadgeClass(visit.computedStatus);
				// Get the visit ID - try multiple possible field names
				const visitId = visit.ID || visit.VisitId || visit.ItemInternalId || visit.Id || '';
				
				return `
					<tr data-id="${visitId}">
						<td>${visit.EngineerName || 'N/A'}</td>
						<td>${visit.CustomerName || 'N/A'}</td>
						<td>${formatDateForDisplay(visit.DateOfRequirement)}</td>
						<td>${formatDateForDisplay(visit.PlanOfDeputation)}</td>
						<td>${calculateVisitEndDate(visit.PlanOfDeputation, visit.Duration)}</td>
						<td>${visit.Duration || 'N/A'}</td>
						<td>${visit.VisitPlace || 'N/A'}</td>
						<td>${visit.Purpose || 'N/A'}</td>
						<td><span class="badge ${statusClass}">${visit.computedStatus}</span></td>
						<td>${visit.Zone || 'N/A'}</td>
						<td>
							<button class="btn btn-sm btn-outline-primary edit-btn" 
									title="Edit"
									data-id="${visitId}">
								<i class="fas fa-edit"></i>
							</button>
						</td>
					</tr>
				`;
			}).join('');
            
            // Update table
            const tbody = document.querySelector("#visitsTable tbody");
            tbody.innerHTML = tableVisits.length > 0 ? 
                tableBodyHtml : 
                '<tr><td colspan="10" class="text-center">No visits match your filters</td></tr>';
            
			
			// Add click handlers to edit buttons
			document.querySelectorAll('.edit-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					const visitId = btn.getAttribute('data-id');
					// Try to find the visit by multiple possible ID fields
					const visit = allVisits.find(v => 
						(v.ID == visitId) || 
						(v.VisitId == visitId) || 
						(v.ItemInternalId == visitId) ||
						(v.Id == visitId)
					);
					
					if (visit) {
						showVisitDetails(visit);
					} else {
						console.error("Visit not found with ID:", visitId);
						console.log("Available visits:", allVisits);
					}
				});
			});
            

			// Add click handlers to table rows
			document.querySelectorAll('#visitsTable tbody tr').forEach(row => {
				row.addEventListener('click', () => {
					// Remove selected class from all rows
					document.querySelectorAll('#visitsTable tbody tr').forEach(r => {
						r.classList.remove('selected');
					});
					
					// Add selected class to clicked row
					row.classList.add('selected');
					
					const visitId = row.getAttribute('data-id');
					// Try to find the visit by multiple possible ID fields
					const visit = allVisits.find(v => 
						(v.ID == visitId) || 
						(v.VisitId == visitId) || 
						(v.ItemInternalId == visitId) ||
						(v.Id == visitId)
					);
					if (visit) {
						// You could show a quick preview here if desired
					}
				});
			});
        }

        /*
         * Update charts with current data
         */
 
		  <!-- ‚úÖ Paste this block right here -->
		  // === Reusable function that mirrors "All Engineer Visits" table logic ===
		  function computeVisitState(v, selectedDate) {
			const st = (v.computedStatus || v.status || "").toString().toLowerCase().trim();
			if (["completed", "cancelled", "postponed", "rejected"].includes(st)) {
			  return st;
			}

			const plan = parseSharePointDate(v.PlanOfDeputation || v.planofdeputation || v.planOfDeputation || v.plan_of_deputation);
			const endStr = calculateVisitEndDate(v.PlanOfDeputation || v.planofdeputation || v.planOfDeputation || v.plan_of_deputation, v.Duration || v.duration);
			const end = parseSharePointDate(endStr);

			if (!plan) return st || "unknown";

			let sel = selectedDate ? new Date(selectedDate) : new Date();
			sel.setHours(0, 0, 0, 0);

			if (end && sel >= plan && sel <= end) return "active";
			if (plan > sel) return "upcoming";
			return "active";
		  }
		  <!-- ‚úÖ End of helper block -->
		  
// === Render Modern Workload Calendar ===
let workloadStart = new Date();
workloadStart.setHours(0, 0, 0, 0);  // ‚úÖ Normalize to local midnight so grid aligns with real ‚Äútoday‚Äù

function shiftWorkload(days) {
  if (days === 0) {
    // Center the window around today (7 days before)
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    workloadStart = new Date(today);
    workloadStart.setDate(today.getDate() - 7);
  } else {
    // Move window by given days (Prev = -14, Next = +14)
    workloadStart.setDate(workloadStart.getDate() + days);
  }

  workloadStart.setHours(0, 0, 0, 0);
  renderWorkloadCalendar(allVisits);
}

function renderWorkloadCalendar(visits) {
  console.log("üß© renderWorkloadCalendar() called with", visits.length, "visits");

  // ‚úÖ Remove cancelled visits entirely
  visits = visits.filter(v => (v.Status || "").toLowerCase() !== "cancelled");

  // ‚úÖ Collect engineers and sort alphabetically
  const engineers = [
  ...new Set([
    ...visits.map(v => v.EngineerName).filter(Boolean),
    ...(allPresences ? allPresences.map(p => p.EngineerName).filter(Boolean) : [])
  ])
].sort((a, b) => a.localeCompare(b));
  engineers.sort((a, b) => a.localeCompare(b));
console.log("üß© Combined engineers list:", engineers);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const startDate = new Date(workloadStart);
  const endDate = new Date(startDate);
  endDate.setDate(startDate.getDate() + 13);

  if (engineers.length === 0) {
    document.getElementById('workloadBoardContainer').innerHTML =
      '<div class="text-center text-muted py-4">No engineers found.</div>';
    return;
  }

  let html = `<div class="workload-grid">`;

  // ‚úÖ Header row
  html += `<div class="workload-head workload-engineer">Engineer</div>`;

  const dateArray = [];
  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const label = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
    html += `<div class="workload-head">${label}</div>`;
    dateArray.push(new Date(d));
  }

  // ‚úÖ Rows
  engineers.forEach(name => {
    const engineerVisits = visits.filter(v => v.EngineerName === name);
    html += `<div class="workload-engineer sticky-left" style="left:0;">${name}</div>`;

    dateArray.forEach(dateCheck => {
      let cls = 'cell-empty';
      let matchedVisit = null;

      engineerVisits.forEach(v => {
        const st = (v.computedStatus || '').toLowerCase();
        let plan = parseSharePointDate(v.PlanOfDeputation);
        let end = parseSharePointDate(calculateVisitEndDate(v.PlanOfDeputation, v.Duration));

        if (plan) plan = new Date(plan.getFullYear(), plan.getMonth(), plan.getDate());
        if (end) end = new Date(end.getFullYear(), end.getMonth(), end.getDate());
		if (plan && end && dateCheck >= plan && dateCheck <= end) {
		  if (st === 'completed') cls = 'cell-complete';
		  else if (st === 'postponed') cls = 'cell-postponed';  // ü©µ Postponed highlight
		  else if (plan > today) cls = 'cell-upcoming';
		  else cls = 'cell-active';
		  matchedVisit = v;
		}
      });
	  
    // ====== Presence Overlay (Sheet2) ======
    if (Array.isArray(allPresences) && allPresences.length > 0) {
      const presence = allPresences.find(p => {
        const from = new Date(p.FromDate);
        const to = new Date(p.ToDate);
        from.setHours(0, 0, 0, 0);
        to.setHours(23, 59, 59, 999);
        return (
          p.EngineerName?.trim().toLowerCase() === name.trim().toLowerCase() &&
          dateCheck >= from && dateCheck <= to
        );
      });

		if (presence) {
		  if (presence.PresenceType.toLowerCase() === "leave") cls = "presence-leave";       // üî¥ Leave
		  else if (presence.PresenceType.toLowerCase() === "wfh") cls = "presence-wfh";      // ü©∂ Work From Home
		  else if (presence.PresenceType.toLowerCase() === "office") cls = "presence-office"; // ü©µ Office
		}
    }

      // ‚úÖ Add identifying data attributes (for precise tooltip match)
      const tooltipData = matchedVisit
        ? `
          data-engineer="${name}"
          data-customer="${matchedVisit.CustomerName || ''}"
          data-purpose="${matchedVisit.Purpose || ''}"
          data-plan="${formatDateForDisplay(matchedVisit.PlanOfDeputation)}"
        `
        : "";

		// Format small date label
		const smallDate = dateCheck.toLocaleDateString('en-GB', {
		  day: '2-digit',
		  month: 'short'
		}).replace(' ', '-');

		// Auto-contrast text color depending on cell type
		let dateColor = "rgba(0,0,0,0.18)"; // default dull

		if (cls === "cell-active")      dateColor = "rgba(255,255,255,0.35)";
		if (cls === "cell-upcoming")    dateColor = "rgba(0,0,0,0.20)";
		if (cls === "cell-complete")    dateColor = "rgba(255,255,255,0.30)";
		if (cls === "presence-leave")   dateColor = "rgba(255,255,255,0.40)";
		if (cls === "presence-wfh")     dateColor = "rgba(0,0,0,0.22)";
		if (cls === "presence-office")  dateColor = "rgba(0,0,0,0.20)";
		if (cls === "cell-postponed")   dateColor = "rgba(0,0,0,0.25)";

		// Render cell
		html += `
		  <div class="workload-cell ${cls}" 
			   data-engineer="${name}" 
			   data-date="${dateCheck.toISOString().slice(0,10)}"
			   ${tooltipData}
			   style="position:relative;">

		<div style="
		  position:absolute;
		  top:50%;
		  left:50%;
		  transform:translate(-50%, -50%);
		  font-size:8px;
		  color:${dateColor};
		  pointer-events:none;
		  text-align:center;
		  line-height:1;">
		  ${smallDate}
		</div>


		  </div>`;

    });
  });

  html += `</div>`;
  const container = document.getElementById('workloadBoardContainer');
  container.innerHTML = html;

  // ‚úÖ Tooltip logic
  const tooltip = document.getElementById("workloadTooltip");
  let activeTooltipCell = null;

  container.querySelectorAll('.workload-cell').forEach(cell => {
    cell.addEventListener('click', e => {
      const engineer = cell.dataset.engineer;
      const customer = cell.dataset.customer;
      const purpose = cell.dataset.purpose;
      const planDate = cell.dataset.plan;

      if (!customer && !purpose) {
        tooltip.style.display = 'none';
        activeTooltipCell = null;
        return;
      }

      if (activeTooltipCell === cell) {
        tooltip.style.display = 'none';
        activeTooltipCell = null;
        return;
      }

      activeTooltipCell = cell;

      // ‚úÖ Strong match: engineer + customer + purpose + plan date
      const matchedVisit = visits.find(v =>
        (v.EngineerName === engineer) &&
        (v.CustomerName === customer) &&
        (v.Purpose === purpose) &&
        (formatDateForDisplay(v.PlanOfDeputation) === planDate)
      );

      if (matchedVisit) {
        const planDisplay = formatDateForDisplay(matchedVisit.PlanOfDeputation);
        const endDisplay = calculateVisitEndDate(matchedVisit.PlanOfDeputation, matchedVisit.Duration);

		// ‚úÖ Derive status using same logic that decides the cell color
		let status = '';
		const plan = parseSharePointDate(matchedVisit.PlanOfDeputation);
		const end = parseSharePointDate(calculateVisitEndDate(matchedVisit.PlanOfDeputation, matchedVisit.Duration));
		const st = (matchedVisit.computedStatus || '').toLowerCase();

		if (st === 'completed') status = 'completed';
		else if (plan && plan > today) status = 'upcoming';
		else if (plan && plan <= today && end && end >= today) status = 'active';
		else status = (matchedVisit.Status || 'unknown').toLowerCase();
		const statusClass = getStatusBadgeClass(status);

        tooltip.innerHTML = `
          <div><strong>Engineer:</strong> ${engineer || 'N/A'}</div>
          <div><strong>Customer:</strong> ${customer || 'N/A'}</div>
          <div><strong>Purpose:</strong> ${purpose || 'N/A'}</div>
          <hr style="margin:6px 0;">
          <div><strong>Plan Date:</strong> ${planDisplay || 'N/A'}</div>
          <div><strong>End Date:</strong> ${endDisplay || 'N/A'}</div>
          <div><strong>Status:</strong> <span class="badge ${statusClass}">
            ${status.toUpperCase()}
          </span></div>
        `;
      } else {
        tooltip.innerHTML = `
          <div><strong>Customer:</strong> ${customer || 'N/A'}</div>
          <div><strong>Purpose:</strong> ${purpose || 'N/A'}</div>
        `;
      }

      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY - 15) + 'px';
      tooltip.style.display = 'block';
    });
  });

  // ‚úÖ Hide tooltip on outside click
  document.addEventListener('click', e => {
    if (activeTooltipCell && !container.contains(e.target)) {
      tooltip.style.display = 'none';
      activeTooltipCell = null;
    }
  });
}

 
/* ECharts-based timeline with hover + pinned click tooltip */
function updateTimelineChart(visits) {
  // container
  const container = document.getElementById("timelineEChart");
  const tooltipCard = document.getElementById("timelineTooltipCard");
  if (!container) return;
  if (tooltipCard) { tooltipCard.style.display = "none"; tooltipCard.dataset.mode = "hover"; }

  // build date range: today -10 to today +40 (or based on data)
  const today = new Date();
  today.setHours(0,0,0,0);
  let start = new Date(today);
  start.setDate(start.getDate() - 10);
  let end = new Date(today);
  end.setDate(end.getDate() + 40);

  // If visits present, expand range to include earliest visit
  if (visits && visits.length) {
    let minDate = null;
    visits.forEach(v => {
      const p = parseSharePointDate(v.PlanOfDeputation);
      if (p && !isNaN(p.getTime())) {
        if (!minDate || p < minDate) minDate = new Date(p.getFullYear(), p.getMonth(), p.getDate());
      }
    });
    if (minDate && minDate < start) start = minDate;
  }

  // build labels and counts
  const labels = [];
  const totals = [];
  const breakdown = {}; // dateStr -> {active, upcoming, completed, list: [...]}

  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const key = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
    labels.push(`${d.getMonth()+1}/${d.getDate()}`);
    totals.push(0);
    breakdown[key] = { active:0, upcoming:0, completed:0, list: [] };
  }

  // populate counts from visits
  if (visits && visits.length) {
    visits.forEach(v => {
      const plan = parseSharePointDate(v.PlanOfDeputation);
      const endStr = calculateVisitEndDate(v.PlanOfDeputation, v.Duration);
      const pEnd = parseSharePointDate(endStr);
      if (!plan || isNaN(plan.getTime())) return;
      const startDate = new Date(plan.getFullYear(), plan.getMonth(), plan.getDate());
      const lastDate = (pEnd && !isNaN(pEnd.getTime())) ? new Date(pEnd.getFullYear(), pEnd.getMonth(), pEnd.getDate()) : startDate;
      for (let d = new Date(startDate); d <= lastDate; d.setDate(d.getDate() + 1)) {
        const key = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;

		// Determine visit state logically
		let st = (v.computedStatus || "").toLowerCase();
		const plan = parseSharePointDate(v.PlanOfDeputation);
		const end = parseSharePointDate(calculateVisitEndDate(v.PlanOfDeputation, v.Duration));
		const now = new Date();
		now.setHours(0, 0, 0, 0);

		// --- Final Correct Active / Upcoming / Completed Logic ---

		if (breakdown[key]) {
		  // compute the visit state for THIS date (key should be date string aligned with parseSharePointDate)
		  // Build a Date object for the day (midnight)
		  const parts = key.split('/'); // if your keys are M/D/YYYY or M/D
		  // safer: reuse creation from earlier ‚Äî but here's robust:
		  let selDate = new Date(); // default fallback (today)
			selDate.setHours(0,0,0,0);
		  // compute selDate by offset from start if you already have startRange variable in scope
		  // Otherwise: try parseSharePointDate on a full date string - adjust according to how 'key' is created
		  // For typical key format 'M/D/YYYY' or 'M/D', do:
		  try {
			const kparts = key.split('/');
			if (kparts.length === 3) selDate = new Date(parseInt(kparts[2]), parseInt(kparts[0]) - 1, parseInt(kparts[1]));
			else {
			  // if no year in key, default to current year
			  const y = (new Date()).getFullYear();
			  selDate = new Date(y, parseInt(kparts[0]) - 1, parseInt(kparts[1]));
			}
			selDate.setHours(0,0,0,0);
		  } catch(e) {
			selDate = new Date(); selDate.setHours(0,0,0,0);
		  }

		  const state = computeVisitState(v, selDate);

		  if (state === "completed") {
			breakdown[key].completed++;
			breakdown[key].list.push(v);
		  } else if (state === "upcoming") {
			breakdown[key].upcoming++;
			breakdown[key].list.push(v);
		  } else if (state === "active") {
			breakdown[key].active++;
			breakdown[key].list.push(v);
		  } else {
			// cancelled/postponed/rejected => skip or track separately if you want
		  }
		}
		
      }
    });

    // map totals array
    let idx = 0;
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const key = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
      totals[idx] = (breakdown[key].active || 0) + (breakdown[key].upcoming || 0) + (breakdown[key].completed || 0);
      idx++;
    }
  } else {
    // demo random data if no visits
    for (let i=0;i<totals.length;i++) totals[i] = Math.floor(Math.random()*5);
  }

	// init chart
	const myChart = echarts.init(container, null, { renderer: 'canvas' });

	const todayLabel = `${today.getMonth() + 1}/${today.getDate()}`;
	const todayIndex = labels.findIndex(l => l === todayLabel);

	const option = {
		tooltip: { show: false }, // we use custom tooltip card
		grid: { left: 60, right: 20, top: 40, bottom: 80 },

		dataZoom: [
			{ 
				type: 'slider', 
				show: true, 
				xAxisIndex: 0, 
				height: 20, 
				bottom: 30,
				// Will be replaced by today-centering logic below
				startValue: 0,  
				endValue: 10    
			},
			{ 
				type: 'inside', 
				zoomOnMouseWheel: false, 
				moveOnMouseWheel: false, 
				moveOnMouseMove: true 
			}
		],

		xAxis: {
			type: 'category',
			data: labels,
			axisLabel: { rotate: 45 },
			axisLine: { lineStyle: { color: '#aaa' } }
		},

		yAxis: {
			type: 'value',
			name: 'Visits',
			minInterval: 1,
			axisLine: { lineStyle: { color: '#aaa' } },
			splitLine: { lineStyle: { color: '#eee' } }
		},

		series: [{
			name: 'Visits',
			type: 'line',
			data: totals,
			smooth: true,
			showAllSymbol: true,

			// ‚≠ê 2x bigger dot for TODAY (16px vs 8px)
			symbolSize: function (value, params) {
				return params.dataIndex === todayIndex ? 16 : 8;
			},

			itemStyle: {
				color: function (params) {
					return params.dataIndex === todayIndex ? '#2ecc71' : '#2980b9';
				},
				borderWidth: function (params) {
					return params.dataIndex === todayIndex ? 3 : 0;
				},
				borderColor: '#ffffff',
				shadowBlur: function (params) {
					return params.dataIndex === todayIndex ? 18 : 0;
				},
				shadowColor: 'rgba(46,204,113,0.45)'
			},

			lineStyle: { color: '#3498db', width: 3 },
			areaStyle: { color: 'rgba(52,152,219,0.08)' }
		}]
	};


	// ‚≠ê‚≠ê‚≠ê AUTO-CENTER TODAY IN VIEW (¬±3 days ‚Üí 1 week view)
	if (todayIndex >= 0) {
		const windowSize = 7;      // total days to show
		const half = Math.floor(windowSize / 2);

		const start = Math.max(todayIndex - half, 0);
		const end   = todayIndex + half;

		option.dataZoom[0].startValue = start;
		option.dataZoom[0].endValue = end;
	}


	// Apply chart
	myChart.setOption(option);

	// responsive behavior
	window.addEventListener('resize', () => myChart.resize());

  // helper to position tooltip card
  function showTooltipAt(dateIdx, eventOrPoint, mode) {
    if (!tooltipCard) return;
    const dateParts = (()=> {
      // reconstruct full date string key by iterating from start
      const base = new Date(start);
      base.setDate(base.getDate() + dateIdx);
      return `${base.getMonth()+1}/${base.getDate()}/${base.getFullYear()}`;
    })();
    const info = breakdown[dateParts] || { active:0, upcoming:0, completed:0, list: [] };

    // build content
    if (mode === 'click') {
      tooltipCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>${labels[dateIdx]}</strong><button id="closeTimelineTooltip" class="btn-close" aria-label="Close"></button></div>
        <div style="margin-top:8px;">Total: <span class="badge bg-primary">${info.active+info.upcoming+info.completed}</span></div>
        <div style="margin-top:8px;"><span class="badge bg-success me-1">Active ${info.active}</span>
        <span class="badge bg-warning me-1">Upcoming ${info.upcoming}</span>
        <span class="badge bg-secondary">Completed ${info.completed}</span></div>
        <div style="margin-top:10px; max-height:220px; overflow:auto;">

        ${info.list.length 
		  ? '<table class="table table-sm mb-0"><thead><tr><th>Engineer</th><th>Customer</th><th>Plan</th><th>End</th><th>Zone</th></tr></thead><tbody>' 
			+ info.list.map(v => {
				const planDate = formatDateForDisplay(v.PlanOfDeputation) || '';
				const endDate = formatDateForDisplay(calculateVisitEndDate(v.PlanOfDeputation, v.Duration)) || '';
				return `<tr>
				  <td>${v.EngineerName || ''}</td>
				  <td>${v.CustomerName || ''}</td>
				  <td>${planDate}</td>
				  <td>${endDate}</td>
				  <td>${v.Zone || ''}</td>
				</tr>`;
			  }).join('') 
			+ '</tbody></table>' 
		  : '<div class="text-muted">No visits</div>'}
		</div>`;
      tooltipCard.dataset.mode = 'click';
    } else {
      tooltipCard.innerHTML = `
		  <div class="card shadow-sm border-0" style="width:220px;">
			<div class="card-body py-2 px-3">
			  <div class="fw-bold text-primary mb-1">${labels[dateIdx]}</div>
			  <div class="d-flex justify-content-between small text-muted">
				<span>Active</span><span class="fw-semibold text-success">${info.active}</span>
			  </div>
			  <div class="d-flex justify-content-between small text-muted">
				<span>Upcoming</span><span class="fw-semibold text-warning">${info.upcoming}</span>
			  </div>
			  <div class="d-flex justify-content-between small text-muted">
				<span>Completed</span><span class="fw-semibold text-secondary">${info.completed}</span>
			  </div>
			</div>
		  </div>`;
      tooltipCard.dataset.mode = 'hover';
    }

    // position near event point or center of chart if not available
    let x = (eventOrPoint && eventOrPoint.event) ? eventOrPoint.event.clientX + 12 : (container.getBoundingClientRect().left + 20);
    let y = (eventOrPoint && eventOrPoint.event) ? eventOrPoint.event.clientY - 12 : (container.getBoundingClientRect().top + 20);
    // keep in viewport
    tooltipCard.style.left = Math.max(8, Math.min(window.innerWidth - 320, x)) + 'px';
    tooltipCard.style.top = Math.max(60, Math.min(window.innerHeight - 180, y)) + 'px';
    tooltipCard.style.display = 'block';

    // close button for click mode
    const closeBtn = document.getElementById('closeTimelineTooltip');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        tooltipCard.style.display = 'none';
        tooltipCard.dataset.mode = 'hover';
      });
    }
  }

  // hover behavior (show small card)
  myChart.on('mousemove', function(paramsEvent) {
    try {
      if (!paramsEvent || !paramsEvent.batch || paramsEvent.batch.length===0) return;
      const p = paramsEvent.batch[0];
      const dataIndex = p.dataIndex;
      if (!tooltipCard) return;
      if (tooltipCard.dataset.mode === 'click') return; // pinned
      showTooltipAt(dataIndex, paramsEvent, 'hover');
    } catch(e) { /* ignore */ }
  });

  // mouse leave hide tooltip unless pinned
  myChart.getZr().on('globalout', function() {
    try {
      if (!tooltipCard) return;
      if (tooltipCard.dataset.mode === 'click') return;
      tooltipCard.style.display = 'none';
    } catch(e) {}
  });

  // click to pin tooltip
	let selectedIdx = null;

	myChart.on('click', function(paramsEvent) {
	  try {
		if (!paramsEvent || (paramsEvent.dataIndex === undefined)) return;
		const idx = paramsEvent.dataIndex;
		selectedIdx = idx;
		showTooltipAt(idx, paramsEvent, 'click');

		// update point color for selected
		const series = myChart.getOption().series[0];
		const colors = series.data.map((v, i) => i === idx ? '#e74c3c' : '#2980b9');
		series.itemStyle = { color: (p) => colors[p.dataIndex] };
		myChart.setOption({ series: [series] }, false);
	  } catch(e) {}
	});
	}

function updateCharts(visits) {
            updateEngineerChart(visits);
            updateCustomerChart(visits);
            updateTimelineChart(visits);
        }

        /*
         * Update Engineer visit
         */
        function updateEngineerChart(visits) {
		  const ctx = document.getElementById('engineerChart').getContext('2d');

		  // --- Group by engineer, count visits and total days ---
		  const engineerStats = {};
		  visits.forEach(v => {
			const eng = v.EngineerName?.trim() || "Unknown";
			const dur = parseInt(v.Duration) || 1;
			if (!engineerStats[eng]) engineerStats[eng] = { visits: 0, days: 0 };
			engineerStats[eng].visits++;
			engineerStats[eng].days += dur;
		  });

		  // --- Convert to array and sort by total days (descending) ---
		  const sortedEngineers = Object.entries(engineerStats)
			.map(([name, data]) => ({ name, ...data }))
			.sort((a, b) => b.days - a.days); // no slice ‚Üí all engineers shown

		  const labels = sortedEngineers.map(e => e.name);
		  const visitCounts = sortedEngineers.map(e => e.visits);
		  const visitDays = sortedEngineers.map(e => e.days);

		  // Destroy previous chart if it exists
		  if (charts.engineerChart) {
			charts.engineerChart.destroy();
		  }

		  // --- Create new chart with visits + days ---
		  charts.engineerChart = new Chart(ctx, {
			type: 'bar',
			data: {
			  labels: labels,
			  datasets: [
				{
				  label: 'Visits',
				  data: visitCounts,
				  backgroundColor: 'rgba(52, 152, 219, 0.6)',
				  borderColor: '#2980b9',
				  borderWidth: 1
				},
				{
				  label: 'Days',
				  data: visitDays,
				  backgroundColor: 'rgba(39, 174, 96, 0.6)',
				  borderColor: '#27ae60',
				  borderWidth: 1
				}
			  ]
			},
			options: {
			  responsive: true,
			  maintainAspectRatio: false,
			  scales: {
				y: {
				  beginAtZero: true,
				  ticks: { precision: 0 }
				}
			  },
			  plugins: {
				legend: { position: 'bottom' },
				tooltip: {
				  callbacks: {
					label: function (context) {
					  const e = sortedEngineers[context.dataIndex];
					  return `${e.name}: ${e.visits} visits (${e.days} days)`;
					}
				  }
				}
			  }
			}
		  });
		}


        /*
         * Update customer chart
         */
        function updateCustomerChart(visits) {
            const ctx = document.getElementById('customerChart').getContext('2d');
            
            // Group visits by customer
            const customerCounts = {};
            visits.forEach(visit => {
                const customer = visit.CustomerName || 'Unknown';
                customerCounts[customer] = (customerCounts[customer] || 0) + 1;
            });
            
            // Sort customers by count (descending)
            const sortedCustomers = Object.entries(customerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10
            
            const labels = sortedCustomers.map(c => c[0]);
            const data = sortedCustomers.map(c => c[1]);
            
            // Destroy previous chart if it exists
            if (charts.customerChart) {
                charts.customerChart.destroy();
            }
            
            // Create new chart
            charts.customerChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
                            '#1abc9c', '#d35400', '#c0392b', '#16a085', '#27ae60'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12
                            }
                        }
                    }
                }
            });
        }

/*
 * Update timeline chart with fixed visible window and scrollable future
 */
/* --------------------------
		   Timeline tooltip (click = details, hover = breakdown)
		   -------------------------- */
		function showTimelineTooltip(dateStr, visits, canvas, evt, mode = 'click') {
		  const tooltipCard = document.getElementById("timelineTooltipCard");
		  tooltipCard.dataset.mode = mode;

		  const normalizeDate = d => {
			if (!d) return null;
			const date = new Date(d);
			if (isNaN(date.getTime())) return null;
			return new Date(date.getFullYear(), date.getMonth(), date.getDate());
		  };

		  const check = normalizeDate(parseSharePointDate(dateStr));
		  if (!check) {
			tooltipCard.style.display = "none";
			return;
		  }

		  const today = new Date();
		  today.setHours(0, 0, 0, 0);

		  // Collect visits by type
		  const dayActive = visits.filter(v => {
			const start = normalizeDate(parseSharePointDate(v.PlanOfDeputation));
			const end = normalizeDate(parseSharePointDate(calculateVisitEndDate(v.PlanOfDeputation, v.Duration)));
			return start && end && check >= start && check <= end && v.computedStatus === "active";
		  });

		  const dayCompleted = visits.filter(v => {
			const start = normalizeDate(parseSharePointDate(v.PlanOfDeputation));
			const end = normalizeDate(parseSharePointDate(calculateVisitEndDate(v.PlanOfDeputation, v.Duration)));
			return start && end && check >= start && check <= end && v.computedStatus === "completed";
		  });

			// Upcoming visits for forecast
			let dayUpcoming = [];
			if (check >= today) {
			  dayUpcoming = visits.filter(v => {
				const plan = normalizeDate(parseSharePointDate(v.PlanOfDeputation));
				// Only count visits that have not started yet by this check date
				return plan && plan > check && v.computedStatus === "upcoming";
			  });
			}

		  if (mode === 'click') {
			// CLICK MODE: Detailed card with checkboxes
			const buildRows = (visitsArr) => visitsArr.map(v => {
			  const words = (v.Purpose || "").split(" ");
			  const trimmedPurpose = words.length > 8 ? words.slice(0, 8).join(" ") + "‚Ä¶" : (v.Purpose || "N/A");
			  return `
				<tr>
				  <td>${v.EngineerName || "N/A"}</td>
				  <td>${v.CustomerName || "N/A"}</td>
				  <td>${formatDateForDisplay(v.PlanOfDeputation) || "N/A"}</td>
				  <td>${v.Zone || "N/A"}</td>
				  <td>${trimmedPurpose}</td>
				</tr>`;
			}).join("");

			tooltipCard.innerHTML = `
			  <div style="display:flex; justify-content:space-between; align-items:center;">
				<h6 style="margin:0;">${dateStr} - Visit Details</h6>
				<button id="closeTooltipBtn" class="btn-close" aria-label="Close"></button>
			  </div>

			  <!-- Checkboxes -->
			  <div style="margin:8px 0; font-size:0.9rem;">
				<label class="me-3"><input type="checkbox" id="showActiveChk" checked /> Active</label>
				<label class="me-3"><input type="checkbox" id="showUpcomingChk" checked /> Upcoming</label>
				<label><input type="checkbox" id="showCompletedChk" checked /> Completed</label>
			  </div>

			  <div id="activeSection">
				<h6>Active Visits (${dayActive.length})</h6>
				${dayActive.length ? `
				  <table class="table table-sm mb-0">
					<thead><tr><th>Engineer</th><th>Customer</th><th>Plan</th><th>Zone</th><th>Purpose</th></tr></thead>
					<tbody>${buildRows(dayActive)}</tbody>
				  </table>` : `<div class="text-muted">No Active Visits</div>`}
			  </div>

			  <div id="upcomingSection" style="margin-top:10px;">
				<h6>Upcoming Visits (${dayUpcoming.length})</h6>
				${dayUpcoming.length ? `
				  <table class="table table-sm mb-0">
					<thead><tr><th>Engineer</th><th>Customer</th><th>Plan</th><th>Zone</th><th>Purpose</th></tr></thead>
					<tbody>${buildRows(dayUpcoming)}</tbody>
				  </table>` : `<div class="text-muted">No Upcoming Visits</div>`}
			  </div>

			  <div id="completedSection" style="margin-top:10px;">
				<h6>Completed Visits (${dayCompleted.length})</h6>
				${dayCompleted.length ? `
				  <table class="table table-sm mb-0">
					<thead><tr><th>Engineer</th><th>Customer</th><th>Plan</th><th>Zone</th><th>Purpose</th></tr></thead>
					<tbody>${buildRows(dayCompleted)}</tbody>
				  </table>` : `<div class="text-muted">No Completed Visits</div>`}
			  </div>
			`;
				// Match card width to chart width
				const chartContainer = document.getElementById("timelineChart").parentElement;
				if (chartContainer) {
				  tooltipCard.style.width = chartContainer.offsetWidth + "px";
				}

			tooltipCard.style.display = "block";

			// Checkbox filters
			document.getElementById("showActiveChk").addEventListener("change", e => {
			  document.getElementById("activeSection").style.display = e.target.checked ? "block" : "none";
			});
			document.getElementById("showUpcomingChk").addEventListener("change", e => {
			  document.getElementById("upcomingSection").style.display = e.target.checked ? "block" : "none";
			});
			document.getElementById("showCompletedChk").addEventListener("change", e => {
			  document.getElementById("completedSection").style.display = e.target.checked ? "block" : "none";
			});

			// Close button
			document.getElementById("closeTooltipBtn").addEventListener("click", () => {
			  tooltipCard.style.display = "none";
			  tooltipCard.dataset.mode = "hover"; // reset back so hover works again
			});


		  } else {
			// HOVER MODE
			if (check < today) {
			  tooltipCard.innerHTML = `
				<div style="padding:10px; min-width:180px;">
				  <strong>${dateStr}</strong>
				  <div style="margin-top:8px;">
					<span class="badge bg-secondary me-2">Utilization: ${dayCompleted.length + dayActive.length}</span>
				  </div>
				</div>
			  `;
			} else if (check.getTime() === today.getTime()) {
			  tooltipCard.innerHTML = `
				<div style="padding:10px; min-width:180px;">
				  <strong>${dateStr}</strong>
				  <div style="margin-top:8px;">
					<span class="badge bg-success me-2">Active: ${dayActive.length}</span>
				  </div>
				</div>
			  `;
			} else {
			  tooltipCard.innerHTML = `
				<div style="padding:10px; min-width:180px;">
				  <strong>${dateStr}</strong>
				  <div style="margin-top:8px;">
					<span class="badge bg-success me-2">Active: ${dayActive.length}</span>
					<span class="badge bg-warning me-2">Upcoming: ${dayUpcoming.length}</span>
				  </div>
				  <div class="mt-2 text-muted small">Total: ${dayActive.length + dayUpcoming.length}</div>
				</div>
			  `;
			}
			tooltipCard.style.display = "block";
		  }

		  // --- Dynamic positioning ---
		  const tooltipWidth = tooltipCard.offsetWidth || 250;
		  const tooltipHeight = tooltipCard.offsetHeight || 150;
		  let x = evt.clientX + 15;
		  let y = evt.clientY - tooltipHeight - 15;
		  if (x + tooltipWidth > window.innerWidth) x = evt.clientX - tooltipWidth - 15;
		  if (y < 0) y = evt.clientY + 20;
		  tooltipCard.style.left = `${x}px`;
		  tooltipCard.style.top = `${y}px`;

		  // Hide only in hover mode
		  if (mode === 'hover') {
			tooltipCard.onmouseleave = () => {
			  tooltipCard.style.display = "none";
			};
		  } else {
			tooltipCard.onmouseleave = null; // disable auto-hide in click mode
		  }
		} 

        /*
         * Update filter dropdowns with current options
         */
		function updateFilterDropdowns(visits) {
			// Engineer dropdown should always be from allVisits
			const engineers = [...new Set(allVisits.map(v => v.EngineerName).filter(Boolean))].sort();
			engineerFilterEl.innerHTML = '<option value="">All Engineers</option>' + 
				engineers.map(e => `<option value="${e}">${e}</option>`).join('');

			// Customer dropdown should also always be from allVisits
			const customers = [...new Set(allVisits.map(v => v.CustomerName).filter(Boolean))].sort();
			customerFilterEl.innerHTML = '<option value="">All Customers</option>' + 
				customers.map(c => `<option value="${c}">${c}</option>`).join('');
		}


        /*
         * Show visit details in the edit card
         */
        function showVisitDetails(visit, isNew = false) {
            console.log("Full visit object:", visit);
            console.log("Is new visit:", isNew);
            
            // Populate form fields
            document.getElementById("visitIdInput").value = isNew ? '' : (visit.ID || visit.VisitId || visit.ItemInternalId || '');
			console.log("Setting visitIdInput to:", isNew ? '' : (visit.ID || visit.VisitId || visit.ItemInternalId || ''));
			console.log("Available ID fields:", {
				ID: visit.ID,
				VisitId: visit.VisitId,
				ItemInternalId: visit.ItemInternalId
			});
			
            document.getElementById("engineerNameInput").value = visit.EngineerName || '';
            document.getElementById("customerNameInput").value = visit.CustomerName || '';
            document.getElementById("dateRequirementInput").value = formatDateForInput(visit.DateOfRequirement);
            document.getElementById("planOfDeputationInput").value = formatDateForInput(visit.PlanOfDeputation);
            document.getElementById("visitPlaceInput").value = visit.VisitPlace || '';
            document.getElementById("visitInput").value = visit.Visit || '';
            document.getElementById("purposeInput").value = visit.Purpose || '';
            document.getElementById("statusInputSelect").value = visit.Status || 'active';
            document.getElementById("mscInput").value = visit.Msc || '';
            document.getElementById("loggerInput").value = visit.Logger || '';
            document.getElementById("etagInput").value = isNew ? '' : (visit['@odata.etag'] || '');
            document.getElementById("zoneInput").value = visit.Zone || 'AZ';
            document.getElementById("durationInput").value = visit.Duration || '';

            // Handle CreatedAt field for new vs existing visits
            let createdAtValue = '';
            if (isNew) {
                createdAtValue = visit.CreatedAt || new Date().toISOString();
            } else {
                // Try to find the CreatedAt value for existing visits
                const possibleFieldNames = [
                    'CreatedAt', 'Created', 'Timestamp', 'Created Date', 'CreatedDateTime',
                    'Created0', 'CreatedOn', 'CreatedTime', 'CreationDate', 'Created_x0020_Date'
                ];
                
                for (const fieldName of possibleFieldNames) {
                    if (visit[fieldName]) {
                        createdAtValue = visit[fieldName];
                        console.log("Found CreatedAt value in field:", fieldName, createdAtValue);
                        break;
                    }
                }
            }
            
            // Show the formatted date in the visible field (for display only)
            document.getElementById("createdAtInput").value = formatDateTimeForInput(createdAtValue);
            
            // Store the original UTC timestamp in the hidden field
            document.getElementById("createdAtUTCInput").value = createdAtValue;
            
            // Change title and button text for new visits
            document.querySelector("#visitDetailCard h4").textContent = 
                isNew ? "Create New Visit" : "Visit Details";
            document.getElementById("submitButton").textContent = 
                isNew ? "Create Visit" : "Save & Update";
            
            console.log("Using CreatedAt as ID:", createdAtValue);

            // Show the card
            document.getElementById("visitDetailCard").style.display = 'block';
            
            // Focus on the first input
            document.getElementById("engineerNameInput").focus();
        }

        /*
         * Format date and time for input field (YYYY-MM-DDTHH:MM)
         */
        function formatDateTimeForInput(dateTime) {
            if (!dateTime) return '';
            
            const dateObj = new Date(dateTime);
            if (isNaN(dateObj.getTime())) return '';
            
            const year = dateObj.getFullYear();
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            const hours = dateObj.getHours().toString().padStart(2, '0');
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        /*
         * Hide visit details card
         */
        function hideVisitDetails() {
            document.getElementById("visitDetailCard").style.display = 'none';
            document.getElementById("visitForm").reset();
        }

        /*
         * Show settings panel
         */
        function showSettingsPanel() {
            document.getElementById("settingsPanel").style.display = 'block';
        }

        /*
         * Hide settings panel
         */
        function hideSettingsPanel() {
            document.getElementById("settingsPanel").style.display = 'none';
        }

        /*
         * Show toast notification
         */
        function showToast(title, message) {
            const toast = document.getElementById("liveToast");
            const toastTitle = document.getElementById("toastTitle");
            const toastMessage = document.getElementById("toastMessage");
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Show the toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

		/*
		 * Format date for SharePoint (MM/DD/YYYY)
		 */
		function formatDateForSharePoint(dateString) {
			if (!dateString) return '';
			
			// If it's already in MM/DD/YYYY format, return as-is
			if (typeof dateString === 'string' && dateString.includes('/')) {
				return dateString;
			}
			
			// Input is YYYY-MM-DD from date input
			const parts = dateString.split('-');
			if (parts.length === 3) {
				// Return in "MM/DD/YYYY" format for Excel
				return `${parseInt(parts[1])}/${parseInt(parts[2])}/${parts[0]}`;
			}
			
			// Try to parse as a date object
			try {
				const dateObj = new Date(dateString);
				if (!isNaN(dateObj.getTime())) {
					return `${dateObj.getMonth() + 1}/${dateObj.getDate()}/${dateObj.getFullYear()}`;
				}
			} catch (e) {
				console.error("Error parsing date:", e);
			}
			
			return dateString; // Fallback to original value
		}

        /*
         * Setup all event listeners
         */
        function setupEventListeners() {
            // Filter change events
            engineerFilterEl.addEventListener('change', () => applyFiltersAndRender());
            customerFilterEl.addEventListener('change', () => applyFiltersAndRender());
            dateFilterEl.addEventListener('change', () => applyFiltersAndRender());
            statusFilterEl.addEventListener('change', () => applyFiltersAndRender());
			document.getElementById("zoneTopFilter").addEventListener('change', () => applyFiltersAndRender());
            zoneFilterEl.addEventListener('change', () => updateVisitLists(filteredVisits));
            listStatusFilterEl.addEventListener('change', () => updateVisitLists(filteredVisits));
            tableZoneFilterEl.addEventListener('change', () => updateVisitsTable(filteredVisits));
			 tableStatusFilterEl.addEventListener("change", () => {
				const selected = Array.from(tableStatusFilterEl.selectedOptions).map(o => o.text);
				tableStatusFilterEl.title = selected.join(", ") || "All Statuses"; // tooltip
				applyFiltersAndRender();
			});
            searchInputEl.addEventListener('input', () => updateVisitsTable(filteredVisits));
            
            // Refresh button
            document.getElementById("refreshData").addEventListener('click', () => {
                loadDataFromEndpoint();
            });
            
            // Export button
            document.getElementById("exportReport").addEventListener('click', () => {
                // Simple export to CSV
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Engineer,Customer,Date of Requirement,Plan of Deputation,Duration,Visit Place,Purpose,Status,Zone\n"
                    + filteredVisits.map(v => 
                        `"${v.EngineerName || ''}","${v.CustomerName || ''}","${formatDateForDisplay(v.DateOfRequirement)}",` +
                        `"${formatDateForDisplay(v.PlanOfDeputation)}","${v.Duration || ''}","${v.VisitPlace || ''}",` +
                        `"${v.Purpose || ''}","${v.computedStatus}","${v.Zone || ''}"`
                    ).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "engineer_visits.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast("Export", "Data exported to CSV");
            });
            
            // New Visit button
            document.getElementById("newVisitBtn").addEventListener('click', () => {
                const newVisit = createNewVisit();
                showVisitDetails(newVisit, true);
            });

			// Visit form submission
			document.getElementById("visitForm").addEventListener('submit', async (e) => {
				e.preventDefault();
				
				const visitId = document.getElementById("visitIdInput").value;
				const isNewVisit = !visitId;
				
				// ADD DEBUGGING
				console.log("Form submission - Visit ID:", visitId);
				console.log("Form submission - Is new visit:", isNewVisit);
				console.log("Form submission - CreatedAtUTC:", document.getElementById("createdAtUTCInput").value);
 
				
				// Determine which endpoint to use
				const endpoint = isNewVisit ? settings.createEndpoint : settings.postEndpoint;
				console.log(`Using ${isNewVisit ? "CREATE" : "POST"} endpoint: ${endpoint}`);
				console.log(`Is new visit: ${isNewVisit}`);
				console.log(`Visit ID: ${visitId}`);
				
				if (!endpoint) {
					showToast("Error", isNewVisit ? 
						"CREATE endpoint not configured. Please set it in Settings." : 
						"POST endpoint not configured. Please set it in Settings.");
					return;
				}
				
				// Prepare the data based on whether it's a new visit or an update
				let requestData = {};
				
				// Add a unique identifier for debugging
				requestData.requestId = new Date().getTime();
				
				if (isNewVisit) {
					// Data structure for NEW visits (create)
					requestData = {
						EngineerName: document.getElementById("engineerNameInput").value,
						CustomerName: document.getElementById("customerNameInput").value,
						DateOfRequirement: formatDateForSharePoint(document.getElementById("dateRequirementInput").value),
						PlanOfDeputation: formatDateForSharePoint(document.getElementById("planOfDeputationInput").value),
						Duration: document.getElementById("durationInput").value,
						VisitPlace: document.getElementById("visitPlaceInput").value,
						Visit: document.getElementById("visitInput").value,
						Purpose: document.getElementById("purposeInput").value,
						Status: document.getElementById("statusInputSelect").value,
						Zone: document.getElementById("zoneInput").value,
						Msc: document.getElementById("mscInput").value,
						Logger: document.getElementById("loggerInput").value,
						CreatedAt: new Date().toISOString() // Add this line for new visits
					};
				    // ADD DEBUGGING HERE
					console.log("DateOfRequirement formatted:", requestData.DateOfRequirement);
					console.log("PlanOfDeputation formatted:", requestData.PlanOfDeputation);
					console.log("CreatedAt value:", requestData.CreatedAt);	
					console.log("Creating new visit with data:", requestData);
				}
				
				else {
					// Data structure for EXISTING visits (update)
					// For updates, we need to send only the changed fields and the ID
					requestData = {
						VisitId: visitId,
						EngineerName: document.getElementById("engineerNameInput").value,
						CustomerName: document.getElementById("customerNameInput").value,
						DateOfRequirement: formatDateForSharePoint(document.getElementById("dateRequirementInput").value),
						PlanOfDeputation: formatDateForSharePoint(document.getElementById("planOfDeputationInput").value),
						Duration: document.getElementById("durationInput").value,
						VisitPlace: document.getElementById("visitPlaceInput").value,
						Visit: document.getElementById("visitInput").value,
						Purpose: document.getElementById("purposeInput").value,
						Status: document.getElementById("statusInputSelect").value,
						Zone: document.getElementById("zoneInput").value,
						Msc: document.getElementById("mscInput").value,
						Logger: document.getElementById("loggerInput").value,
						CreatedAtUTC: document.getElementById("createdAtUTCInput").value
					};

					// Add Duration field if it exists in your form
					if (!requestData.Duration) {
						requestData.Duration = document.getElementById("durationInput")?.value || '';
					}

					// Add Zone field if it exists in your form  
					if (!requestData.Zone) {
						requestData.Zone = document.getElementById("zoneInput")?.value || 'AZ';
					}

					// ADD DEBUGGING HERE TOO
					console.log("DateOfRequirement formatted:", requestData.DateOfRequirement);
					console.log("PlanOfDeputation formatted:", requestData.PlanOfDeputation);
					console.log("CreatedAt value:", requestData.CreatedAt);
					console.log("Updating visit with data:", requestData);
				}
				
				showLoadingOverlay();
				
				try {
					const response = await fetch(endpoint, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestData)
					});
					
					// Handle empty response or non-JSON response
					const responseText = await response.text();
					let result = {};
					
					try {
						if (responseText) {
							result = JSON.parse(responseText);
						}
					} catch (parseError) {
						console.warn("Response is not valid JSON, but request succeeded:", responseText);
					}
					
					if (!response.ok) {
						console.error("Server error response:", responseText);
						throw new Error(`HTTP error! Status: ${response.status}. Response: ${responseText}`);
					}
					
					console.log("Server response:", result);
					
					showToast("Success", isNewVisit ? "New visit created successfully" : "Visit updated successfully");
					hideVisitDetails();
					
					// Clear cache and force refresh to see the new data
					localStorage.removeItem("cachedVisitsData");
					localStorage.removeItem("cachedVisitsTimestamp");
					
					// Refresh data to get the latest changes
					await loadDataFromEndpoint();
				} catch (error) {
					console.error(isNewVisit ? "Error creating visit:" : "Error updating visit:", error);
					showToast("Error", `Failed to ${isNewVisit ? "create" : "update"} visit: ${error.message}`);
				} finally {
					hideLoadingOverlay();
				}
			});            
				
            // Cancel edit button
            document.getElementById("cancelEditBtn").addEventListener('click', () => {
                hideVisitDetails();
            });
            
			// Settings form submission
			document.getElementById("settingsForm").addEventListener('submit', (e) => {
				e.preventDefault();
				
				const formData = new FormData(e.target);
				const newSettings = {};

				formData.forEach((value, key) => {
					// Convert number fields to integers
					if (key === 'refreshInterval' || key === 'cacheDuration' || key === 'overdueThreshold') {
						newSettings[key] = parseInt(value);
					} 
					// Convert checkbox to boolean
					else if (key === 'includeTimeInDateComparison') {
						newSettings[key] = true; // Checkbox is only included when checked
					}
					else {
						newSettings[key] = value;
					}
				});

				// ‚úÖ Get the latest unified Presence endpoint from the input box
				newSettings.presenceEndpoint =
				  document.getElementById("presenceEndpointInput")?.value ||
				  settings.presenceEndpoint ||
				  "";

				// ‚úÖ Persist presence endpoint separately into localStorage for next session
				if (newSettings.presenceEndpoint) {
				  localStorage.setItem("presenceEndpoint", newSettings.presenceEndpoint);
				  console.log("üíæ Presence endpoint saved:", newSettings.presenceEndpoint);
				}

				// Handle checkbox separately since it's not included in form data when unchecked
				newSettings.includeTimeInDateComparison =
				  document.getElementById("includeTimeInDateComparison").checked;
				
				saveSettings(newSettings);
				hideSettingsPanel();
			});

				
            // Cancel settings button
            document.getElementById("cancelSettingsBtn").addEventListener('click', () => {
                hideSettingsPanel();
            });
            
            // Settings button
            document.getElementById("settingsButton").addEventListener('click', () => {
                showSettingsPanel();
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                const visitDetailCard = document.getElementById("visitDetailCard");
                const settingsPanel = document.getElementById("settingsPanel");
                
                if (e.target === visitDetailCard) {
                    hideVisitDetails();
                }
                
                if (e.target === settingsPanel) {
                    hideSettingsPanel();
                }
            });
			
        }
</script>
<!-- Choices.js initialization -->
<script>
 document.addEventListener("DOMContentLoaded", function() {
		const statusFilter = document.getElementById("tableStatusFilter");
		new Choices(statusFilter, {
			removeItemButton: true,
			placeholderValue: 'Select Status',
			searchEnabled: false,
			itemSelectText: '',
			shouldSort: false
		});

		const zoneFilter = document.getElementById("tableZoneFilter");
		new Choices(zoneFilter, {
			removeItemButton: true,
			placeholderValue: 'Select Zone',
			searchEnabled: false,
			itemSelectText: '',
			shouldSort: false
		});
	});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>
<!-- Smart Planning Logic -->
<script>
 (function(){
  // Helper: parse dates (uses existing parseSharePointDate and calculateVisitEndDate)
  function detectOverlaps(visits) {
    const overlaps = [];
    const grouped = {};
    const filtered = (visits || []).filter(v => ["active","upcoming"].includes((v.computedStatus||'').toLowerCase()));
    filtered.forEach(v => {
      const name = v.EngineerName || "Unknown";
      if (!grouped[name]) grouped[name] = [];
      grouped[name].push(v);
    });
    Object.keys(grouped).forEach(engineer => {
      const items = grouped[engineer]
        .map(v => ({
          ...v,
          start: parseSharePointDate(v.PlanOfDeputation),
          end: parseSharePointDate(calculateVisitEndDate(v.PlanOfDeputation, v.Duration))
        }))
        .filter(v => v.start && v.end)
        .sort((a,b) => a.start - b.start);
		for (let i = 0; i < items.length - 1; i++) {
		  const current = items[i];
		  const next = items[i + 1];

		  // üîπ Include same-day or back-to-back visits as overlaps (1-day tolerance)
		  if (next.start <= new Date(current.end.getTime() + 86400000)) {
			overlaps.push({ engineer, visit1: current, visit2: next });
		  }
		}
    });
    return overlaps;
  }

function computeWorkloadSummary(visits) {
  const today = new Date();
  const startOfWeek = new Date(today);
  startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);          // Saturday

  const summary = {};

  visits.forEach(v => {
    if (!/(active|upcoming)/i.test(v.computedStatus || "")) return;
    const engineer = v.EngineerName || "Unknown";

    // --- Convert Excel serial or ISO date ---
    let start;
    if (!isNaN(v.PlanOfDeputation)) {
      // Excel serial (days since 1899-12-30)
      start = new Date((Number(v.PlanOfDeputation) - 25569) * 86400 * 1000);
    } else {
      start = new Date(v.PlanOfDeputation);
      if (isNaN(start)) start = new Date(v.PlanOfDeputationObj || v.PlanStartDate || v.PlanDate);
    }

    // --- Calculate end date ---
    const dur = parseInt(v.Duration) || 1;
    const end = new Date(start);
    end.setDate(start.getDate() + dur - 1);

    if (isNaN(start) || isNaN(end)) return;

    // --- Count days of this week ---
    let daysThisWeek = 0;
    const day = new Date(start);
    while (day <= end) {
      if (day >= startOfWeek && day <= endOfWeek) daysThisWeek++;
      day.setDate(day.getDate() + 1);
    }

    if (!summary[engineer]) summary[engineer] = { days: 0, active: 0, upcoming: 0 };
    summary[engineer].days += daysThisWeek;
    if (/active/i.test(v.computedStatus)) summary[engineer].active++;
    if (/upcoming/i.test(v.computedStatus)) summary[engineer].upcoming++;
  });

  return summary;
}


  function showOverlapModal(overlaps) {
    const body = document.getElementById('overlapModalBody');
    if (!overlaps || overlaps.length===0) {
      body.innerHTML = '<p class="text-muted">No conflicts detected.</p>';
    } else {
      const rows = overlaps.map(o=>`<tr>
        <td>${o.engineer}</td>
        <td>${o.visit1.CustomerName||''} (${formatDateForDisplay(o.visit1.PlanOfDeputation)} - ${calculateVisitEndDate(o.visit1.PlanOfDeputation, o.visit1.Duration)})</td>
        <td>${o.visit2.CustomerName||''} (${formatDateForDisplay(o.visit2.PlanOfDeputation)} - ${calculateVisitEndDate(o.visit2.PlanOfDeputation, o.visit2.Duration)})</td>
        <td>${o.visit1.Zone||''}</td>
      </tr>`).join('');
      body.innerHTML = `<table class="table table-sm table-bordered"><thead><tr><th>Engineer</th><th>Visit 1</th><th>Visit 2</th><th>Zone</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    new bootstrap.Modal(document.getElementById('overlapModal')).show();
  }

  function showWorkloadModal(summary) {
    const body = document.getElementById('workloadModalBody');
    if (!summary || Object.keys(summary).length===0) {
      body.innerHTML = '<p class="text-muted">No workload data available.</p>';
    } else {
      const rows = Object.keys(summary).sort().map(name=>{
        const s = summary[name];
        let color='text-success'; if (s.days>10) color='text-danger'; else if (s.days>5) color='text-warning';
        return `<tr><td>${name}</td><td class="${color} fw-bold">${s.days}</td><td>${s.active}</td><td>${s.upcoming}</td></tr>`;
      }).join('');
      body.innerHTML = `<table class="table table-sm table-bordered"><thead><tr><th>Engineer</th><th>Days (This Week)</th><th>Active</th><th>Upcoming</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    new bootstrap.Modal(document.getElementById('workloadModal')).show();
  }

function runSmartPlanning() {
  try {
    // Delay a bit to ensure computedStatus is populated
    setTimeout(() => {

      // Only consider active and upcoming visits
      const validVisits = (window.allVisits || []).filter(
        v => /(active|upcoming)/i.test(v.computedStatus || '')
      );

      const overlaps = detectOverlaps(validVisits);
      const workload = computeWorkloadSummary(validVisits);
      const statsContainer = document.getElementById('statsCards');
      if (!statsContainer) return;

      // ----- Conflict Card -----
      if (!document.getElementById('conflictCard')) {
        const cardHTML = `
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card border-top border-danger" id="conflictCard"
                 style="border-top-width:4px; cursor:pointer;">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted">Overlap Conflicts</h6>
                  <div class="stat-number text-danger">${overlaps.length}</div>
                </div>
                <div class="stat-icon text-danger"><i class="fas fa-exclamation-triangle"></i></div>
              </div>
            </div>
          </div>`;
        statsContainer.insertAdjacentHTML('beforeend', cardHTML);
        document.getElementById('conflictCard').addEventListener('click', () => showOverlapModal(overlaps));
      } else {
        const el = document.querySelector('#conflictCard .stat-number');
        if (el) el.innerText = overlaps.length;
      }

      // ----- Workload Card -----
      if (!document.getElementById('workloadCard')) {
        const cardHTML = `
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card border-top border-primary" id="workloadCard"
                 style="border-top-width:4px; cursor:pointer;">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted">Weekly Workload</h6>
                  <div class="stat-number text-primary">${Object.keys(workload).length}</div>
                </div>
                <div class="stat-icon text-primary"><i class="fas fa-chart-bar"></i></div>
              </div>
            </div>
          </div>`;
        statsContainer.insertAdjacentHTML('beforeend', cardHTML);
        document.getElementById('workloadCard').addEventListener('click', () => showWorkloadModal(workload));
      } else {
        const el = document.querySelector('#workloadCard .stat-number');
        if (el) el.innerText = Object.keys(workload).length;
      }

      // ----- Highlight overlapping rows -----
      const overlapIDs = new Set((overlaps || []).flatMap(o => [o.visit1.ID, o.visit2.ID]));
      document.querySelectorAll('#visitsTable tbody tr').forEach(tr => {
        const vid = tr.getAttribute('data-id');
        if (overlapIDs.has(vid)) tr.classList.add('table-danger');
        else tr.classList.remove('table-danger');
      });

      // ----- Toast Alert -----
      if ((overlaps || []).length > 0 && typeof showToast === 'function') {
        showToast('Conflict Alert', `${overlaps.length} engineers have overlapping visits.`);
      }

    }, 400); // 400ms delay ensures computedStatus exists
  } catch (e) {
    console.error('runSmartPlanning error', e);
  }
}

  // Hook into existing applyFiltersAndRender to run after each refresh
  const originalApply = window.applyFiltersAndRender;
  if (typeof originalApply === 'function') {
    window.applyFiltersAndRender = function() {
      originalApply();
      setTimeout(runSmartPlanning, 250);
    };
  } else {
    // If applyFiltersAndRender not ready yet, poll until available
    const intv = setInterval(()=>{
      if (typeof window.applyFiltersAndRender === 'function') {
        clearInterval(intv);
        const orig = window.applyFiltersAndRender;
        window.applyFiltersAndRender = function() {
          orig();
          setTimeout(runSmartPlanning, 250);
        };
      }
    }, 200);
  }

  // Also run once on load (after slight delay to let initial rendering finish)
  window.addEventListener('load', ()=> setTimeout(runSmartPlanning, 800));

function showPage(pageId) {
  // Hide all page sections
  document.querySelectorAll('.page-section').forEach(section => {
    section.classList.add('d-none');
  });

  // Show the selected page
  const activePage = document.getElementById(pageId);
  if (activePage) {
    activePage.classList.remove('d-none');
    activePage.scrollIntoView({ behavior: "smooth", block: "start" });
  } else {
    console.warn("‚ö†Ô∏è Page ID not found:", pageId);
  }

  // When switching to Workload page, render it fresh
  if (pageId === 'workloadPage') {
    console.log("üîÑ Rendering Workload Page...");
    if (window.allVisits && window.allVisits.length > 0) {
      renderWorkloadCalendar(window.allVisits);
    } else {
      console.warn("‚ö†Ô∏è Workload data not ready yet ‚Äî will re-render after load.");
      // Automatically re-render once data becomes available
      const interval = setInterval(() => {
        if (window.allVisits && window.allVisits.length > 0) {
          renderWorkloadCalendar(window.allVisits);
          clearInterval(interval);
          console.log("‚úÖ Workload page rendered after data load.");
        }
      }, 500);
    }
  }
}
window.showPage = showPage;

// Optional: sidebar toggle (you can add a button later)
function toggleSidebar() {
  document.getElementById('sidebarMenu').classList.toggle('collapsed');
}
window.toggleSidebar = toggleSidebar; // ‚úÖ also global
})();
</script>
