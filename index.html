<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mitra v1.2 ‚Äî Unified (Login ‚Ä¢ Visits ‚Ä¢ Presence)</title>
<style>
:root{
  --accent:#0f6cbd;
  --bg:#f4f8fb;
  --card:#ffffff;
  --muted:#6b7280;
  --radius:14px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg),#fff);
  color:#0b2540;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.app{max-width:520px;margin:0 auto;padding-bottom:110px}

/* HEADER */
.header{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:0 0 14px 14px;
  background:linear-gradient(90deg,var(--accent),#0a5f8f);
  color:#fff;
  position:sticky;
  top:0;
  z-index:1000;
}
.brand{font-weight:700;font-size:20px}
#loggedUserInline{font-size:14px;font-weight:600;margin-left:10px}
.headerActions{margin-left:auto;display:flex;gap:10px;align-items:center}
.roundBtn{
  width:42px;height:42px;border-radius:50%;border:0;background:white;color:#0b2540;font-size:18px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.roundBtn:active{transform:scale(0.96);}

/* ENGINEER NAME ROW (below header) */
.engineerRow{padding:10px 18px;font-weight:600;color:#0b2540}

/* CARD */
.card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 10px 30px rgba(11,37,70,0.06);margin:14px}
.label{font-size:13px;color:var(--muted);margin-bottom:8px}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid #e6eef6;background:#fff;font-size:15px;margin-bottom:12px}
.btn{background:var(--accent);color:#fff;padding:12px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
.small{padding:8px 10px;border-radius:8px;border:1px solid #e6eef6;background:#fff}

/* VISITS */
.visitsHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.refreshBtn{background:#0f6cbd;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
.visitCard{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(11,37,70,0.04);cursor:pointer}
.visitTitle{font-size:17px;font-weight:700;margin-bottom:6px}
.visitSub{color:var(--muted);font-size:14px;margin-bottom:6px}
.statusBadge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 90px;
  height: 28px;
  padding: 0 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  text-transform: capitalize;
  color: #fff;
}


/* NEW STATUS COLORS */
.statusActive {
  background: #16a34a;     /* green */
  color: #fff;
}

.statusUpcoming {
  background: #eab308;     /* yellow */
  color: #000;
}

.statusCompleted {
  background: #6b7280;     /* grey */
  color: #fff;
}

.statusCancelled {
  background: #dc2626;     /* red */
  color: #fff;
}

.statusPostponed {
  background: #60a5fa;     /* pale blue */
  color: #000;
}


/* MODAL */
.modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:18px}
.modalCard{background:#fff;border-radius:12px;padding:18px;max-width:520px;width:100%;box-shadow:0 12px 36px rgba(0,0,0,0.2);max-height:90vh;overflow:auto}
.modalClose{float:right;font-size:22px;cursor:pointer;color:#333}

/* BOTTOM NAV (WhatsApp style) */
.bottomNav{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 32px);
  max-width:520px;
  display:flex;
  gap:14px;
  z-index:1500;
}
.navBtn{
  flex:1;
  text-align:center;
  padding:12px 10px;
  border-radius:999px;
  font-weight:700;
  background:#f1f5f9;
  color:#0b2540;
  cursor:pointer;
  box-shadow:0 8px 18px rgba(11,37,70,0.04);
}
.navBtn.active{background:var(--accent);color:#fff;box-shadow:0 12px 30px rgba(11,37,70,0.08)}

/* TOAST */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:120px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:2000}

/* SETTINGS BOTTOM SHEET (slide-up) */
.sheetWrap{position:fixed;left:0;right:0;bottom:0;top:0;display:none;z-index:2000}
.sheetBackdrop{position:absolute;inset:0;background:rgba(0,0,0,0.45)}
.sheetCard{
  position:absolute;
  left:0;right:0;
  bottom:0;
  background:#fff;
  border-radius:16px 16px 0 0;
  padding:18px;
  transform:translateY(100%);
  transition:transform 280ms cubic-bezier(.2,.9,.3,1);
  box-shadow:0 -12px 36px rgba(0,0,0,0.18);
  max-height:70vh;
  overflow:auto;
}
.sheetCard.open{transform:translateY(0%)}

/* small helpers */
.center{display:flex;align-items:center;justify-content:center}
.hidden{display:none}

</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="brand">iMitra</div>
  <div id="loggedUserInline" aria-hidden="true"></div>
  <div class="headerActions">
    <button class="roundBtn" id="btnRefreshTop" title="Refresh" onclick="headerRefresh()">‚ü≥</button>
    <button class="roundBtn" id="btnSettingsTop" title="Settings" onclick="openSettingsSheet()">‚öôÔ∏è</button>
    <button class="roundBtn" id="btnHeaderLogin" title="Login / Logout" onclick="toggleLoginLogout()">üîì</button>
  </div>
</div>

<!-- Engineer name (will show after login) -->


<div class="app">

  <!-- LOGIN CARD (no endpoint here) -->
  <div id="loginCard" class="card">
    <h3 style="margin:0 0 12px 0">Login</h3>

    <div class="label">Username</div>
    <input id="username" class="input" placeholder="e.g. Mano M">

    <div class="label">Password</div>
    <input id="password" type="password" class="input" placeholder="Password">

    <div style="display:flex;gap:8px">
      <button id="btnLogin" class="btn" style="flex:1" onclick="login()">Login</button>
      <button class="btn" style="background:#e6eef6;color:#0b2540;width:110px" onclick="clearSaved()">Clear</button>
    </div>

  </div>

  <!-- VISITS (hidden until login) -->
  <div id="visits" class="card hidden">
  
<div class="visitsHeader" style="display:flex;justify-content:space-between;align-items:center">
  <div style="font-weight:700">My Visits</div>

  <select id="statusFilter" class="small" style="font-size:14px;padding:6px 10px;border-radius:8px" onchange="applyStatusFilter()">
    <option value="all">All</option>
    <option value="active">Active</option>
    <option value="completed">Completed</option>
    <option value="upcoming">Upcoming</option>
    <option value="cancelled">Cancelled</option>
    <option value="postponed">Postponed</option>
  </select>
</div>
	
    <div id="visitsList">Loading...</div>
  </div>

  <!-- PRESENCE (hidden until login) -->
  <div id="presence" class="card hidden">
    <h3 style="margin:0 0 8px 0">Presence</h3>
    <div class="label">Set presence for a date</div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="presenceDate" type="date" class="small" />
      <select id="presenceStatus" class="small">
        <option value="">-- Select status --</option>
        <option>Office</option>
        <option>On Leave</option>
        <option>On Dealer site</option>
      </select>
      <input id="presenceNotes" class="small" placeholder="Notes (optional)">
      <button class="btn" onclick="savePresence()">Save</button>
    </div>

    <div style="margin-top:12px">
      <button class="small" onclick="loadPresence()">Load my presence</button>
    </div>

    <div id="presenceList" style="margin-top:12px">No records</div>
  </div>

</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- BOTTOM NAV (visible only when logged in) -->
<div id="bottomNavWrap" class="bottomNav hidden" role="navigation">
  <div id="navVisits" class="navBtn" onclick="switchTab('visits')">Visits</div>
  <div id="navPresence" class="navBtn" onclick="switchTab('presence')">Presence</div>
</div>

<!-- SETTINGS SHEET (slide-up) -->
<div id="settingsSheet" class="sheetWrap" aria-hidden="true">
  <div class="sheetBackdrop" onclick="closeSettingsSheet()"></div>
  <div id="sheetCard" class="sheetCard" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:700" id="settingsTitle">Settings</div>
      <button onclick="closeSettingsSheet()" style="background:transparent;border:0;font-size:20px;cursor:pointer">‚úï</button>
    </div>

    <div class="label">Power Automate Flow Endpoint (HTTP trigger)</div>
    <input id="sheetFlowUrl" class="input" placeholder="https://your-flow-endpoint"/>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="saveSettings()">Save</button>
      <button class="small" onclick="closeSettingsSheet()">Close</button>
    </div>

    <div class="label" style="margin-top:12px">Saved endpoint will be used by the app when calling your Flow.</div>
  </div>
</div>

<script>
/* ---------------------- State ---------------------- */
let userSelectedFilter = false;

const state = {
  endpoint: localStorage.getItem('mitra_flow') || '',
  username: localStorage.getItem('mitra_user') || '',
  engineerName: localStorage.getItem('mitra_engineer') || '',
  zone: localStorage.getItem('mitra_zone') || ''
};

/* Initialize inputs */
document.getElementById('presenceDate').value = new Date().toISOString().slice(0,10);
document.getElementById('sheetFlowUrl').value = state.endpoint;
document.getElementById('username').value = state.username;

/* Helpers */
function toast(msg, t=2200){ const el=document.getElementById('toast'); el.innerText=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', t); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatDateOnly(s){ if(!s) return ''; try{ const d=new Date(s); if(isNaN(d)) return s; return d.toISOString().split('T')[0]; }catch(e){ return s; } }

/* Post to Flow */
async function postFlow(payload){
  const ep = state.endpoint || localStorage.getItem('mitra_flow') || document.getElementById('sheetFlowUrl').value.trim();
  if(!ep) throw new Error('Flow endpoint missing. Save it in Settings.');
  const res = await fetch(ep, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const txt = await res.text();
    throw new Error('HTTP '+res.status + ' - ' + txt);
  }
  return res.json();
}

/* ---------------------- Settings sheet (slide-up) ---------------------- */
function openSettingsSheet(){
  document.getElementById('sheetCard').classList.add('open');
  document.getElementById('settingsSheet').style.display = 'block';
  document.getElementById('settingsSheet').setAttribute('aria-hidden','false');
  // focus input after small delay
  setTimeout(()=> document.getElementById('sheetFlowUrl').focus(), 220);
}
function closeSettingsSheet(){
  document.getElementById('sheetCard').classList.remove('open');
  // small delay to allow closing animation
  setTimeout(()=> {
    document.getElementById('settingsSheet').style.display = 'none';
    document.getElementById('settingsSheet').setAttribute('aria-hidden','true');
  }, 260);
}
function saveSettings(){
  const url = document.getElementById('sheetFlowUrl').value.trim();
  if(!url){ toast('Please enter endpoint'); return; }
  state.endpoint = url;
  localStorage.setItem('mitra_flow', url);
  toast('Settings saved');
  closeSettingsSheet();
}

/* ---------------------- Login / Logout ---------------------- */
async function login(){
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();

  if(!user){ toast('Enter username'); return; }
  if(!pass){ toast('Enter password'); return; }

  // require endpoint to exist in settings
  const ep = state.endpoint || localStorage.getItem('mitra_flow') || document.getElementById('sheetFlowUrl').value.trim();
  if(!ep){
    toast('Please add endpoint in Settings');
    openSettingsSheet();
    return;
  }

  // Save username locally (we'll update engineerName after flow response)
  state.username = user;
  localStorage.setItem('mitra_user', user);

  const btn = document.getElementById('btnLogin');
  btn.disabled = true; btn.innerText = 'Checking...';

  try{
    const r = await postFlow({ action:'login', username: user, password: pass });

    // engineer name from flow or fallback
    state.engineerName = r.engineerName || user;
    localStorage.setItem('mitra_engineer', state.engineerName);
    if(r.zone){ state.zone = r.zone; localStorage.setItem('mitra_zone', r.zone); }

    // UI changes: hide login card, show engineer name and visits section + bottom nav
    document.getElementById('loginCard').classList.add('hidden');
    document.getElementById('visits').classList.remove('hidden');
    document.getElementById('bottomNavWrap').classList.remove('hidden');

    // header login button becomes logout
    document.getElementById('btnHeaderLogin').innerText = 'üîì';
    document.getElementById('loggedUserInline').innerText = state.engineerName;

    // set endpoint from saved if present
    state.endpoint = state.endpoint || localStorage.getItem('mitra_flow') || document.getElementById('sheetFlowUrl').value.trim();
    document.getElementById('sheetFlowUrl').value = state.endpoint || '';

    // default to visits tab
    switchTab('visits');
    toast('Login success');
  } catch(err){
    console.error(err);
    toast('Login failed: ' + (err.message || ''));
  } finally {
    btn.disabled = false; btn.innerText = 'Login';
  }
}

function clearSaved(){
  localStorage.removeItem('mitra_user');
  localStorage.removeItem('mitra_engineer');
  localStorage.removeItem('mitra_flow');
  localStorage.removeItem('mitra_zone');
  // reset UI and refresh
  state.endpoint = '';
  state.username = '';
  state.engineerName = '';
  document.getElementById('sheetFlowUrl').value = '';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  toast('Cleared local settings');
}

function logout(){
  // Clear local storage
  localStorage.removeItem('mitra_user');
  localStorage.removeItem('mitra_engineer');
  localStorage.removeItem('mitra_zone');

  // Clear runtime state
  state.username = "";
  state.engineerName = "";
  state.zone = "";

  // Reset header
  document.getElementById("loggedUserInline").innerText = "";
  document.getElementById("btnHeaderLogin").innerText = "üîí";

  // Hide all non-login UI
  document.getElementById("visits").classList.add("hidden");
  document.getElementById("presence").classList.add("hidden");
  document.getElementById("bottomNavWrap").classList.add("hidden");

  // Show login card
  document.getElementById("loginCard").classList.remove("hidden");

  // Reset filter logic
  userSelectedFilter = false;

  toast("Logged out");
}


function toggleLoginLogout(){
  if(state.username && state.engineerName){
    // currently logged in -> logout
    logout();
  } else {
    // not logged in -> scroll to login
    document.getElementById('loginCard').scrollIntoView({behavior:'smooth'});
  }
}

/* ---------------------- Visit status classification ---------------------- */

function classifyVisit(v){
  const today = new Date();
  const start = new Date(v.StartDate || v.Start || "");
  const end = new Date(v.EndDate || v.End || "");
  const status = (v.Status || "").toLowerCase();

  // Direct Excel statuses
  if(status === "completed") return "completed";
  if(status === "cancelled") return "cancelled";
  if(status === "postponed") return "postponed";

  // System-calculated Active
  if(start <= today && today <= end){
    return "active";
  }

  // System-calculated Upcoming
  if(start > today){
    return "upcoming";
  }

  // Default fallback
  return "active";
}

let globalVisits = []; // store visits after load

function applyStatusFilter(){
userSelectedFilter = true;
  const f = document.getElementById("statusFilter").value;
  if(f === "all"){
    renderVisits(globalVisits);
    return;
  }

  const filtered = globalVisits.filter(v => classifyVisit(v) === f);
  renderVisits(filtered);
}

/* ---------------------- Tabs & Nav ---------------------- */
function highlightNav(tab){
  document.getElementById('navVisits').classList.remove('active');
  document.getElementById('navPresence').classList.remove('active');
  if(tab==='visits') document.getElementById('navVisits').classList.add('active');
  if(tab==='presence') document.getElementById('navPresence').classList.add('active');
}
function switchTab(name){
  highlightNav(name);
  document.getElementById('visits').classList.toggle('hidden', name!=='visits');
  document.getElementById('presence').classList.toggle('hidden', name!=='presence');
  if(name==='visits') loadVisits();
  if(name==='presence') loadPresence();
}

/* Refresh header */
function headerRefresh(){
userSelectedFilter = false; 
  // if not logged in, do nothing
  if(!state.username) { toast('Not logged in'); return; }
  // refresh the currently visible tab
  if(!document.getElementById('visits').classList.contains('hidden')) loadVisits();
  if(!document.getElementById('presence').classList.contains('hidden')) loadPresence();
  toast('Refreshed');
}

/* ---------------------- Visits ---------------------- */
async function loadVisits(){
  if(!state.username){ return; }
  const listEl = document.getElementById('visitsList');
  listEl.innerHTML = 'Loading visits...';
  try{
    const r = await postFlow({
  action:'getVisits',
  engineerName: state.engineerName,
  username: state.username
});

    if(!r || !r.success){
      listEl.innerHTML = '<i>No visits returned</i>';
      return;
    }
    const arr = (r.visits && r.visits.body) ? r.visits.body : (r.visits || []);
    // ---------------- DEBUG LOGS ----------------
	console.log("Engineer from state:", state.engineerName);
	console.log("Username from state:", state.username);
	console.log("--------------------------------------------------");
	console.log("ALL VISITS FROM FLOW:");

	arr.forEach(v => {
		console.log("Visit EngineerName:", v.EngineerName, "| Customer:", v.CustomerName);
	});
	console.log("--------------------------------------------------");
	// ---------------- DEBUG LOGS END ---------------

	const eng = (state.engineerName || state.username || "").trim().toLowerCase();

const filtered = arr.filter(v => {
  const name = (v.EngineerName || "").trim().toLowerCase();
  // match if exact or contains the short name (works for "Akash" vs "Akash Rajak")
  return name === eng || (eng && name.includes(eng));
});

    if(filtered.length===0){ listEl.innerHTML = '<i>No visits found for ' + escapeHtml(state.engineerName||state.username) + '</i>'; return; }
	globalVisits = filtered;

if(!userSelectedFilter){

    // default view = Active + Upcoming only
    const def = globalVisits.filter(v => {
        const c = classifyVisit(v);
        return c === "active" || c === "upcoming";
    });

    // üëâ If no active/upcoming calls, show relaxed message
    if (def.length === 0) {
        document.getElementById("visitsList").innerHTML = `
            <div style="padding:20px; text-align:center; color:#555; font-size:14px;">
                <div style="font-size:40px; margin-bottom:10px;">üòé</div>
                <b>No Active or Upcoming calls are there for ${escapeHtml(state.engineerName || state.username)}</b>
                <br><br>
                <span>Please use the dropdown above to check Completed or All visits.</span>
            </div>
        `;
        return;   // stop here, do NOT render empty list
    }

    // Otherwise show active + upcoming visits normally
    renderVisits(def);
}
	
	else {
		// user manually selected a filter ‚Üí apply dropdown
		applyStatusFilter();
	}

  } catch(err){
    console.error(err);
    listEl.innerHTML = 'Error loading visits';
    toast('Visits load error');
  }
}

function renderVisits(list){
  const container = document.getElementById('visitsList');
  container.innerHTML = '';
  list.forEach(v=>{
    const start = formatDateOnly(v.StartDate || v.Start || '');
    const end = formatDateOnly(v.EndDate || v.End || '');
    
	const c = classifyVisit(v);

	let badgeClass = "";
	if (c === "active") badgeClass = "statusActive";
	else if (c === "upcoming") badgeClass = "statusUpcoming";
	else if (c === "completed") badgeClass = "statusCompleted";
	else if (c === "cancelled") badgeClass = "statusCancelled";
	else if (c === "postponed") badgeClass = "statusPostponed";


    const card = document.createElement('div');
    card.className = 'visitCard';
    card.onclick = ()=> openVisitModal(v);
    card.innerHTML = `
      <div class="visitTitle">${escapeHtml(v.CustomerName||v.Customer||'‚Äî')}</div>
      <div class="visitSub">${escapeHtml(v.SiteLocation||v.VisitPlace||'')}</div>
      <div class="visitSub">üìÖ ${start} ‚Üí ${end}</div>
      <div class="visitSub">Purpose: ${escapeHtml(v.Details||v.Purpose||'')}</div>
      <div style="margin-top:8px"><span class="statusBadge ${badgeClass}">${c}</span></div>
    `;
    container.appendChild(card);
  });
}
function openVisitModal(v){
  const modal = document.createElement('div'); modal.className='modalOverlay';
  modal.innerHTML = `<div class="modalCard">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">${escapeHtml(v.CustomerName||'')}</div>
      <div class="modalClose" onclick="this.closest('.modalOverlay').remove()">√ó</div>
    </div>
    <div style="margin-top:10px">
      <p><b>Site:</b> ${escapeHtml(v.SiteLocation||'')}</p>
      <p><b>Start:</b> ${escapeHtml(v.StartDate||v.Start||'')}</p>
      <p><b>End:</b> ${escapeHtml(v.EndDate||v.End||'')}</p>
      <p><b>Purpose:</b> ${escapeHtml(v.Details||'')}</p>
      <p><b>Status:</b> ${c}</p>
      <p><b>Zone:</b> ${escapeHtml(v.Zone||'')}</p>
      <p><b>Visit ID:</b> ${escapeHtml(v.VisitID||'')}</p>
    </div>
  </div>`;
  document.body.appendChild(modal);
}

/* ---------------------- Presence ---------------------- */
async function savePresence(){
  if(!state.username){ toast('Login first'); return; }
  const date = document.getElementById('presenceDate').value;
  const status = document.getElementById('presenceStatus').value;
  const notes = document.getElementById('presenceNotes').value;
  if(!date || !status){ toast('Choose date & status'); return; }
  try{
    const payload = { action:'savePresence', presence: { Username: state.username, EngineerName: state.engineerName||state.username, Date: date, Status: status, Notes: notes } };
    const r = await postFlow(payload);
    if(r && r.success){ toast('Presence saved'); loadPresence(); } else toast('Save failed');
  } catch(err){ console.error(err); toast('Presence save error'); }
}
async function loadPresence(){
  if(!state.username){ toast('Login first'); return; }
  const el = document.getElementById('presenceList'); el.innerHTML = 'Loading...';
  try{
    const r = await postFlow({ action:'getPresence', username: state.username });
    const arr = r.present?.body || r.present || [];
    if(!arr || arr.length===0){ el.innerHTML = '<i>No presence records</i>'; return; }
    let html = '<table style="width:100%;border-collapse:collapse"><tr><th style="text-align:left">Date</th><th style="text-align:left">Status</th><th style="text-align:left">Notes</th></tr>';
    arr.forEach(p => { html += `<tr><td>${escapeHtml(p.Date||'')}</td><td>${escapeHtml(p.Status||'')}</td><td>${escapeHtml(p.Notes||'')}</td></tr>` });
    html += '</table>'; el.innerHTML = html;
  } catch(err){ console.error(err); el.innerHTML = 'Error loading presence'; toast('Presence load error'); }
}

/* ---------------------- Auto-load if session exists ---------------------- */
window.addEventListener('load', ()=>{

  // Always restore correct values from localStorage
  state.endpoint = localStorage.getItem('mitra_flow') || '';
  state.username = localStorage.getItem('mitra_user') || '';
  state.engineerName = localStorage.getItem('mitra_engineer') || '';
  state.zone = localStorage.getItem('mitra_zone') || '';

  if(state.username && state.engineerName){
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("visits").classList.remove("hidden");
      document.getElementById("bottomNavWrap").classList.remove("hidden");

      document.getElementById("loggedUserInline").innerText = state.engineerName;
      document.getElementById("btnHeaderLogin").innerText = "üîì";

      switchTab("visits");
  } else {
      document.getElementById("loginCard").classList.remove("hidden");
      document.getElementById("visits").classList.add("hidden");
      document.getElementById("presence").classList.add("hidden");
      document.getElementById("bottomNavWrap").classList.add("hidden");
      document.getElementById("loggedUserInline").innerText = "";
  }
});

</script>
</body>
</html>
